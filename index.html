<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
  body{
    margin:0;
    background:#05070b;
    color:#e6edf6;
    font-family:Inter,system-ui,Arial;
  }
  .wrap{max-width:1200px;margin:40px auto;padding:20px;}
  h1{margin-top:0}
  input,button{
    background:#0b0f19;
    color:#e6edf6;
    border:1px solid #1f2933;
    border-radius:10px;
    padding:10px 14px;
    font-size:14px;
  }
  button{
    cursor:pointer;
    background:linear-gradient(90deg,#7c3aed,#22d3ee);
    border:none;
    color:#05070b;
    font-weight:700;
  }
  button:hover{opacity:.9}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
  .card{
    background:#0f1420;
    border:1px solid #1f2933;
    border-radius:16px;
    padding:16px;
  }
  .status{margin:10px 0;color:#93a4b7;}
  pre{
    background:#0b0f19;
    border-radius:12px;
    padding:16px;
    overflow:auto;
    max-height:70vh;
    font-size:13px;
    line-height:1.45em;
  }
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" placeholder="Password" type="password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

const BASE = "https://fms.item.com";
const CLIENT = "FMS_WEB";

const LOGIN_URL  = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL  = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL= `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_HIST  = `${BASE}/fms-platform-order/shipment-order-history/`;

const $=id=>document.getElementById(id);
let TOKEN=null;

/* =====================================================
   AUTH ‚Äî UNCHANGED (your working logic)
=====================================================*/
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client":CLIENT,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;

  if(!TOKEN) throw new Error("Token missing");
  return TOKEN;
}

async function api(url){
  const t = await auth();
  const r = await fetch(url,{
    method:"GET",
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* =====================================================
   STATUS TRANSITION PARSER
=====================================================*/
function parseTransition(text){
  const m = text.match(/Changed Order Status From \[(.*?)\] to \[(.*?)\]/i);
  if(!m) return null;
  return { from:m[1], to:m[2] };
}

/* =====================================================
   MAIN AUDIT
=====================================================*/
async function audit(){

  $("out").textContent="";
  TOKEN=null;

  try{
    const tripNo = $("trip").value.trim();
    if(!tripNo) throw new Error("Trip # required");

    $("status").textContent="Fetching Task List‚Ä¶";

    const tasks = await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};

    (tasks?.data?.tasks||[]).forEach(t=>{
      if(!t.task_no || !t.tracking_no) return;
      MAP[t.task_no]={
        PRO: t.tracking_no,
        DO : t.shipment_order_no||t.order_no||"",
        PU : t.pu_no||""
      };
    });

    $("status").textContent="Fetching Trip History‚Ä¶";

    const hist = await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const PER_PRO={};

    (hist?.data?.trip_history_list||[]).forEach(h=>{
      const map=MAP[h.task_no];
      if(!map) return;

      if(!PER_PRO[map.PRO]){
        PER_PRO[map.PRO]={
          PRO:map.PRO,
          DO:map.DO,
          PU:map.PU,
          events:[]
        };
      }

      PER_PRO[map.PRO].events.push({
        time:h.time,
        text:h.event_description,
        user:h.user,
        source:"TRIP"
      });
    });

    $("status").textContent="Fetching Shipment History‚Ä¶";

    for(const pro of Object.keys(PER_PRO)){
      const item=PER_PRO[pro];
      if(!item.DO) continue;

      try{
        const ship = await api(SHIP_HIST + item.DO);

        (ship?.data||[]).forEach(s=>{
          const t=parseTransition(s.event||"");

          item.events.push({
            time:s.event_time,
            text:s.event,
            from:t?.from||"",
            to:t?.to||"",
            user:s.user_name||"",
            source:"SHIP"
          });
        });

      }catch{
        item.events.push({
          time:"‚Äî",
          text:"Shipment history unavailable",
          source:"SHIP"
        });
      }
    }

    $("status").textContent="Rendering‚Ä¶";

    let out="";

    for(const pro of Object.keys(PER_PRO).sort()){

      const o=PER_PRO[pro];

      out += `PRO ${o.PRO} | ${o.DO}\n`;
      out += `PU: ${o.PU||"-"}\n`;

      o.events.sort((a,b)=> new Date(a.time) - new Date(b.time));

      o.events.forEach(e=>{

        if(e.source==="SHIP" && e.from){

          out += `(${e.from} ‚Üí ${e.to}) | ${e.time}`;
          if(e.user) out+=` (${e.user})`;
          out+="\n";

        }else{

          out += `Dispatched/Trip Event ‚Üí ${e.time}`;
          if(e.user) out+=` (${e.user})`;
          out+="\n";

        }

      });

      out += "------------------------------------------------------\n\n";
    }

    $("out").textContent = out || "No events found.";
    $("status").textContent="‚úÖ Audit Complete";

  }catch(e){
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
    console.error(e);
  }
}

$("run").addEventListener("click",audit);

})();
</script>
</body>
</html>
