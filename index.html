<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,sans-serif;
}
.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}
h1{margin:0 0 15px;font-size:26px;}
.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}
.row{display:flex;gap:10px;margin-bottom:10px;}
input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
}
button{
  border:none;
  border-radius:12px;
  padding:10px 18px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;
  font-weight:700;
  cursor:pointer;
}
.status{color:var(--muted);}
.timer{color:#22d3ee;font-size:13px;}
pre{
  background:#070b14;
  border-radius:12px;
  padding:16px;
  border:1px solid var(--border);
  max-height:70vh;
  overflow:auto;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="trip" placeholder="Trip #"/>
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="timer" id="timer"></div>
  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

/* CONFIG */
const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL   = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL   = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL    = `${BASE}/fms-platform-order/shipment-order-history/`;
const SEARCH_URL  = `${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

const FMS_USER="RaulEscobar";
const FMS_PASS="FMSoffload1!";

const $=id=>document.getElementById(id);

let TOKEN=null;
let timerInt=null;

/* AUTH */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({account:FMS_USER,password:FMS_PASS})
  });

  if(!r.ok) throw new Error("Login failed");

  const j=await r.json();
  TOKEN=j.token||j?.data?.token;
  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}
async function api(url){
  const t=await auth();
  const r=await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* HELPERS */
function normalizeDO(v){
  if(!v) return "";
  return v.startsWith("DO") ? v : "DO"+v.replace(/[^0-9]/g,"");
}
function isDispatchEvt(t){
  t=t.toLowerCase();
  return (
    t.includes("dispatched") ||
    t.includes("undispatch") ||
    t.includes("un-dispatch") ||
    t.includes("removed")
  );
}
function extractShipmentEvent(e){
  const s=e?.event?.toLowerCase();
  if(!s) return null;

  if(
    s.includes("pickup") ||
    s.includes("delivery") ||
    s.includes("out for delivery") ||
    s.includes("changed order status")
  ){
    return {
      time:e.event_time,
      text:e.event.split("].")[0]+"]"
    };
  }
  return null;
}

/* MAIN */
async function audit(){

  TOKEN=null;
  $("out").textContent="";
  $("status").textContent="Starting‚Ä¶";
  $("timer").textContent="";

  const tripNo=$("trip").value.trim();
  if(!tripNo) return alert("Trip # required");

  const start=Date.now();
  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);

  try{

    /* TASK MAP */
    $("status").textContent="Fetching tasks‚Ä¶";
    const tasks=await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};
    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no) return;
      MAP[t.task_no]={
        PRO:t.tracking_no||"",
        DO: normalizeDO(t.shipment_order_no||t.order_no||""),
        PU: t.pu_no||""
      };
    });

    /* TRIP EVENTS */
    $("status").textContent="Fetching trip history‚Ä¶";
    const hist=await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const tripEvents=[];
    (hist?.data?.trip_history_list||[]).forEach(ev=>{
      if(!isDispatchEvt(ev.event_description||"")) return;

      let PRO="",DO="",PU="";
      const map=ev.task_no?MAP[ev.task_no]:null;
      if(map){PRO=map.PRO;DO=map.DO;PU=map.PU;}

      const raw=ev.event_description||"";

      if(!PRO){
        const m=raw.match(/pro[#:\s]*([0-9]+)/i);
        if(m) PRO=m[1];
      }
      if(!DO){
        const m=raw.match(/do[#:\s]*([0-9]+)/i);
        if(m) DO=normalizeDO(m[1]);
      }

      const d=raw.toLowerCase();

      tripEvents.push({
        PRO:PRO||"(none)",
        DO: DO||"-",
        PU: PU||"-",
        time: ev.time||"",
        text: raw,
        wantPickup: d.includes("pickup"),
        wantDelivery: d.includes("delivery")
      });
    });

    /* SHIPMENT EVENTS */
    $("status").textContent="Loading shipment events‚Ä¶";

    let allShipEvents=[];
    for(const t of tripEvents){

      let DO=t.DO==="-"?"":t.DO;

      if(t.PRO && t.PRO!=="(none)"){
        try{
          const s=await api(SEARCH_URL+t.PRO);
          const found=s?.data?.orders?.[0]?.order_no;
          if(found) DO=normalizeDO(found);
        }catch{}
      }

      if(!DO) continue;

      try{
        const ship=await api(SHIP_URL+DO);
        (ship?.data||[]).forEach(se=>{
          const sx=extractShipmentEvent(se);
          if(sx) allShipEvents.push(sx);
        });
      }catch{}
    }

    /* PAIRING */
    $("status").textContent="Pairing events‚Ä¶";

    const usedShip=new Set();
    const finalPairs=[];

    tripEvents.forEach(t=>{
      let match=null;

      for(let i=0;i<allShipEvents.length;i++){
        if(usedShip.has(i)) continue;
        const sx=allShipEvents[i];
        const txt=sx.text.toLowerCase();

        if(t.wantPickup && !txt.includes("pickup")) continue;

        if(t.wantDelivery){
          if(txt.includes("pickup")) continue;
          if(!(txt.includes("delivery") || txt.includes("out for delivery"))) continue;
        }

        match={sx,idx:i};
        break;
      }

      if(match) usedShip.add(match.idx);

      finalPairs.push({trip:t, ship: match?match.sx:null});
    });

    /* OUTPUT */
    clearInterval(timerInt);
    $("status").textContent="‚úÖ Audit complete";

    let out="";
    finalPairs.forEach(p=>{
      out+=`${p.trip.time} | ${p.trip.text}\n`;
      if(p.ship){
        out+=`  |_ ${p.ship.time} | ${p.ship.text}\n`;
      }else{
        out+=`  |_ ‚Äî No shipment event ‚Äî\n`;
      }
      out+="--------------------------------------\n";
    });

    $("out").textContent=out||"No dispatch events found.";

  }catch(e){
    clearInterval(timerInt);
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
  }

}

$("run").addEventListener("click",audit);

})();
</script>
</body>
</html>
