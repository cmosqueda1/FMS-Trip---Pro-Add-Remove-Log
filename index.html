<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
  body{
    margin:0;
    background:#05070b;
    color:#e6edf6;
    font-family:Inter,system-ui,Arial;
  }
  .wrap{
    max-width:1100px;
    margin:40px auto;
    padding:20px;
  }
  h1{margin-top:0}
  input,button{
    background:#0b0f19;
    color:#e6edf6;
    border:1px solid #1f2933;
    border-radius:10px;
    padding:10px 14px;
    font-size:14px;
  }
  button{
    cursor:pointer;
    background:linear-gradient(90deg,#7c3aed,#22d3ee);
    border:none;
    color:#05070b;
    font-weight:700;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .card{
    background:#0f1420;
    border:1px solid #1f2933;
    border-radius:16px;
    padding:16px;
  }
  pre{
    background:#0b0f19;
    border-radius:12px;
    padding:16px;
    overflow:auto;
    max-height:70vh;
    font-size:13px;
  }
  .status{
    margin:10px 0;
    color:#93a4b7;
  }
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" placeholder="Password" type="password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>
  <div class="status" id="status">Idle</div>
  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

/* ================= CONFIG ================= */

const BASE = "https://fms.item.com";
const CLIENT = "FMS_WEB";

const LOGIN_URL = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_HISTORY = `${BASE}/fms-platform-order/shipment-order-history/`;

const $ = id => document.getElementById(id);
let TOKEN = null;

/* ================= AUTH (UNCHANGED) ================= */

async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent = "Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client": CLIENT,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      account: $("user").value.trim(),
      password: $("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;

  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

/* ================= API HELPER ================= */

async function api(url){
  const t = await auth();

  const r = await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client": CLIENT,
      "fms-token": t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* ================= MATCHER ================= */

function confidence(eventText){
  if(!eventText) return 0;

  if(eventText.includes("Changed Order Status"))
    return 3;

  if(eventText.includes("TaskDispatched") ||
     eventText.includes("TaskUndispatched"))
    return 2;

  if(eventText.includes("TMS sync"))
    return 1;

  return 0;
}

function bestShipmentMatch(tripEvent, shipmentEvents, wantedStatus){

  const tripTime = new Date(tripEvent.time).getTime();
  const candidates = [];

  shipmentEvents.forEach(ev=>{
    if(!ev.status) return;
    if(ev.status !== wantedStatus) return;

    const evTime = new Date(ev.event_time).getTime();

    const diff = Math.abs(evTime - tripTime);

    if(diff > 15 * 60 * 1000) return; // 15 minute window

    const conf = confidence(ev.event);

    if(conf === 0) return;

    candidates.push({
      ...ev,
      _diff: diff,
      _conf: conf
    });
  });

  if(candidates.length === 0)
    return null;

  candidates.sort((a,b)=>{
    if(b._conf !== a._conf) return b._conf - a._conf;
    return a._diff - b._diff;
  });

  return candidates[0];
}

/* ================= MAIN ================= */

async function audit(){

  $("out").textContent = "";
  TOKEN = null;

  try{

    const tripNo = $("trip").value.trim();
    if(!tripNo) throw new Error("Trip # required");

    /* ---- TASKS ---- */
    $("status").textContent="Fetching Task List‚Ä¶";
    const tasks = await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP = {};

    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no || !t.tracking_no) return;

      MAP[t.task_no] = {
        PRO: t.tracking_no,
        DO: t.shipment_order_no || t.order_no || "",
        PU: t.pu_no || ""
      };
    });

    /* ---- TRIP HISTORY ---- */
    $("status").textContent="Fetching Trip History‚Ä¶";
    const hist = await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const PER = {};

    (hist?.data?.trip_history_list || []).forEach(e=>{

      if(!MAP[e.task_no]) return;

      const desc = (e.event_description || "").toLowerCase();

      if(!(desc.includes("dispatched") || desc.includes("undispatched")))
        return;   // filter only dispatch / undispatch

      const m = MAP[e.task_no];

      if(!PER[m.PRO]){
        PER[m.PRO] = {
          PRO: m.PRO,
          DO: m.DO,
          PU: m.PU,
          tripEvents: [],
          shipEvents: []
        };
      }

      PER[m.PRO].tripEvents.push({
        time: e.time,
        desc: e.event_description,
        user: e.user
      });

    });

    /* ---- SHIPMENT HISTORY + MATCH ---- */
    $("status").textContent="Matching Shipment Status Changes‚Ä¶";

    for(const pro of Object.keys(PER)){

      const entry = PER[pro];
      if(!entry.DO) continue;

      let ship;

      try{
        ship = await api(SHIP_HISTORY + entry.DO);
      }catch{
        continue;
      }

      const shipEvents = ship?.data || [];

      entry.tripEvents.forEach(trip=>{

        const want = trip.desc.toLowerCase().includes("undispatch")
          ? "New"
          : ( trip.desc.toLowerCase().includes("pickup") ? "PickupDispatched"
            : trip.desc.toLowerCase().includes("linehaul") ? "LinehaulDispatched"
            : "PickupDispatched" );

        const match = bestShipmentMatch(trip, shipEvents, want);

        if(match){
          entry.shipEvents.push({
            time: match.event_time,
            desc: match.event,
            user: match.user_name || ""
          });
        }
      });
    }

    /* ---- OUTPUT ---- */
    $("status").textContent="Rendering‚Ä¶";

    let out = "";

    for(const pro of Object.keys(PER).sort()){

      const o = PER[pro];

      out += `PRO ${o.PRO}\n`;
      out += `DO  ${o.DO || "-"}\n`;
      out += `PU  ${o.PU || "-"}\n`;

      o.tripEvents.sort((a,b)=>new Date(a.time)-new Date(b.time));

      o.tripEvents.forEach(ev=>{
        out += `  ${ev.time} | ${ev.desc}${ev.user ? ` (${ev.user})` : ""}\n`;
      });

      o.shipEvents.sort((a,b)=>new Date(a.time)-new Date(b.time));

      o.shipEvents.forEach(ev=>{
        out += `  ${ev.time} | Shipment ‚Üí ${ev.desc}${ev.user ? ` (${ev.user})` : ""}\n`;
      });

      out += "--------------------------------------------\n";
    }

    $("out").textContent = out || "No dispatch activity found.";
    $("status").textContent="‚úÖ Audit Complete";

  }
  catch(err){

    $("status").textContent="‚ùå Error";
    $("out").textContent = err.message;
    console.error(err);

  }
}

/* ================= UI ================= */

$("run").addEventListener("click", audit);

})();
</script>
</body>
</html>
