<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
/* ========= THEME ========= */
:root{
  --bg:#05070b;
  --card:#0f1420;
  --panel:#111827;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:radial-gradient(1200px 700px at 30% -10%,#111827 0%,transparent 60%),var(--bg);
  color:var(--text);
  font-family:Inter, system-ui, Arial, sans-serif;
}

.wrap{
  max-width:1200px;
  margin:40px auto;
  padding:20px;
}

h1{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:16px;
}

/* ========= CONTROLS ========= */
.controls{
  display:flex;
  gap:12px;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 16px;
  min-width:180px;
}

button{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;
  border-radius:14px;
  padding:10px 20px;
  font-weight:700;
  cursor:pointer;
}

.status{
  margin-top:12px;
  color:var(--muted);
}

.timer{
  color:#22d3ee;
  font-size:13px;
}

/* ========= CARDS ========= */
.orders{
  margin-top:18px;
  display:grid;
  gap:18px;
}

.order-card{
  background:linear-gradient(180deg,#111827,#0b1220);
  border:1px solid var(--border);
  border-radius:20px;
  box-shadow:0 18px 40px rgba(0,0,0,0.55);
  padding:18px;
}

.order-header{
  display:flex;
  gap:16px;
  padding-bottom:10px;
  border-bottom:1px solid var(--border);
  margin-bottom:10px;
  flex-wrap:wrap;
}

.kv{
  background:#090d15;
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 12px;
  font-weight:600;
}

.kv span{color:var(--muted)}

.timeline{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.trip{
  background:var(--panel);
  border-radius:14px;
  border:1px solid #1c2638;
  padding:10px 12px;
}

.time{
  color:var(--accent2);
  font-size:12px;
}

.text{margin-top:3px}

.ship{
  margin-top:6px;
  margin-left:22px;
  padding:8px 12px;
  background:#070b14;
  border-left:3px solid #22c55e;
  border-radius:6px 12px 12px 6px;
}

.ship .time{color:#22c55e}

.empty{
  opacity:.6;
  font-style:italic;
}
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="controls">
  <input id="trip" placeholder="Trip #">
  <button id="run">Run Audit</button>
</div>

<div class="status" id="status">Idle</div>
<div class="timer" id="timer"></div>

<div id="orders" class="orders"></div>
</div>

<script>
(()=>{
/* ========= CONFIG ========= */
const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL=`${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL=`${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL=`${BASE}/fms-platform-order/shipment-order-history/`;
const SEARCH_URL=`${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

const FMS_USER="RaulEscobar";
const FMS_PASS="FMSoffload1!";

let TOKEN=null,timerInt=null;
const $=id=>document.getElementById(id);

/* ========= AUTH ========= */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({account:FMS_USER,password:FMS_PASS})
  });

  if(!r.ok) throw new Error("Login failed");

  const j=await r.json();
  TOKEN=j.token||j?.data?.token;
  if(!TOKEN) throw new Error("Token missing");
  return TOKEN;
}

async function api(url){
  const t=await auth();
  const r=await fetch(url,{
    headers:{
      accept:"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* ========= HELPERS ========= */
function normalizeDO(v){
  return v
    ? (v.startsWith("DO") ? v : "DO"+v.replace(/[^0-9]/g,""))
    : "";
}

function isDispatch(txt=""){
  const t=txt.toLowerCase();
  return t.includes("dispatched") || t.includes("undispatch") || t.includes("removed");
}

/* strict shipment filter */
function extractShipmentEvent(e){
  const s=e?.event?.toLowerCase();
  if(!s) return null;

  if(
    s.includes("tms sync") ||
    s.includes("sync update") ||
    s.includes("updated ") ||
    s.includes("latitude") ||
    s.includes("longitude") ||
    s.includes("appointment")
  ) return null;

  if(
    s.includes("pickuptask") ||
    s.includes("deliverytask") ||
    s.includes("pickupdispatched") ||
    s.includes("deliverydispatched") ||
    s.includes("taskdispatched") ||
    s.includes("taskundispatched") ||
    s.includes("changed order status")
  ){
    return {time:e.event_time,text:e.event.split("].")[0]+"]"};
  }

  return null;
}

/* ========= MAIN AUDIT ========= */
async function audit(){

  TOKEN=null;
  $("orders").innerHTML="";
  $("status").textContent="Working‚Ä¶";
  $("timer").textContent="";

  const tripNo=$("trip").value.trim();
  if(!tripNo) return alert("Trip # required");

  const start=Date.now();
  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);

  try{

    /* TASK MAP */
    const tasks=await api(`${TASKS_URL}?tripNo=${tripNo}`);
    const MAP={};

    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no) return;
      MAP[t.task_no]={PRO:t.tracking_no||"",DO:normalizeDO(t.shipment_order_no||t.order_no||""),PU:t.pu_no||""};
    });

    /* TRIP EVENTS */
    const hist=await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const orders={};

    (hist?.data?.trip_history_list||[]).forEach(ev=>{
      if(!isDispatch(ev.event_description||"")) return;

      let PRO="",DO="",PU="";
      const m=ev.task_no?MAP[ev.task_no]:null;
      if(m){PRO=m.PRO;DO=m.DO;PU=m.PU;}

      const raw=ev.event_description||"";

      if(!PRO){
        const x=raw.match(/pro[#:\s]*([0-9]+)/i);
        if(x) PRO=x[1];
      }
      if(!DO){
        const y=raw.match(/do[#:\s]*([0-9]+)/i);
        if(y) DO=normalizeDO(y[1]);
      }

      const key=PRO||DO||"UNKNOWN";

      if(!orders[key]){
        orders[key]={PRO:PRO||"(none)",DO:DO||"-",PU:PU||"-",events:[]};
      }

      orders[key].events.push({
        time:new Date(ev.time).getTime(),
        timeLabel:ev.time,
        text:raw,
        wantPickup: raw.toLowerCase().includes("pickup"),
        wantDelivery: raw.toLowerCase().includes("delivery")
      });

    });

    /* SHIPMENT EVENTS */
    let ships=[];

    for(const k in orders){
      let DO=orders[k].DO;

      if(orders[k].PRO && orders[k].PRO!=="(none)"){

        try{
          const s=await api(SEARCH_URL+orders[k].PRO);
          const found=s?.data?.orders?.[0]?.order_no;
          if(found) DO=normalizeDO(found);
        }catch{}
      }

      if(DO && DO!=="-"){
        try{
          const sh=await api(SHIP_URL+DO);
          (sh?.data||[]).forEach(se=>{
            const sx=extractShipmentEvent(se);
            if(sx){
              ships.push({
                time:new Date(sx.time).getTime(),
                timeLabel:sx.time,
                text:sx.text
              });
            }
          });
        }catch{}
      }
    }

    /* ========= NEAREST-TIME PAIRING ========= */
    const used=new Set();

    for(const k in orders){

      orders[k].events.forEach(ev=>{
        let best=null;
        let minDiff=Infinity;

        ships.forEach((s,i)=>{
          if(used.has(i)) return;

          const txt=s.text.toLowerCase();

          if(ev.wantPickup && !txt.includes("pickup")) return;

          if(ev.wantDelivery){
            if(txt.includes("pickup")) return;
            if(!(txt.includes("delivery")||txt.includes("out for delivery"))) return;
          }

          const diff=Math.abs(ev.time-s.time);
          if(diff<minDiff){
            minDiff=diff;
            best={s,i};
          }
        });

        if(best){
          used.add(best.i);
          ev.ship=best.s;
        }
      });

    }

    /* ========= RENDER ========= */
    clearInterval(timerInt);
    $("status").textContent="‚úÖ Audit complete";

    const cont=$("orders");

    for(const k in orders){

      const ord=orders[k];
      const card=document.createElement("div");
      card.className="order-card";

      card.innerHTML=`
        <div class="order-header">
          <div class="kv"><span>PRO:</span> ${ord.PRO}</div>
          <div class="kv"><span>DO:</span> ${ord.DO}</div>
          <div class="kv"><span>PU:</span> ${ord.PU}</div>
        </div>
      `;

      const tl=document.createElement("div");
      tl.className="timeline";

      ord.events.sort((a,b)=>a.time-b.time);

      ord.events.forEach(e=>{
        const block=document.createElement("div");
        block.className="trip";
        block.innerHTML=`
          <div class="time">${e.timeLabel}</div>
          <div class="text">${e.text}</div>
        `;

        const ship=document.createElement("div");
        ship.className="ship";

        if(e.ship){
          ship.innerHTML=`
            <div class="time">${e.ship.timeLabel}</div>
            <div class="text">${e.ship.text}</div>
          `;
        } else {
          ship.innerHTML=`<div class="empty">‚Äî No shipment event ‚Äî</div>`;
        }

        block.appendChild(ship);
        tl.appendChild(block);
      });

      card.appendChild(tl);
      cont.appendChild(card);

    }

  }catch(e){
    clearInterval(timerInt);
    $("status").textContent="‚ùå Error";
    $("orders").innerHTML=e.message;
  }
}

$("run").addEventListener("click",audit);
})();
</script>

</body>
</html>
