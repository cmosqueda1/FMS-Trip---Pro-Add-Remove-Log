<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
body{
  margin:0;
  background:#05070b;
  color:#e6edf6;
  font-family:Inter,system-ui,Arial;
}
.wrap{max-width:1200px;margin:40px auto;padding:20px;}
h1{margin-top:0;font-size:22px}

input,button{
  background:#0b0f19;
  color:#e6edf6;
  border:1px solid #1f2933;
  border-radius:10px;
  padding:10px 14px;
  font-size:14px;
}
button{
  cursor:pointer;
  background:linear-gradient(90deg,#7c3aed,#22d3ee);
  border:none;
  color:#05070b;
  font-weight:700;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

.card{
  background:#0f1420;
  border:1px solid #1f2933;
  border-radius:16px;
  padding:16px;
  box-shadow:0 16px 40px rgba(0,0,0,.5);
}

pre{
  background:#0b0f19;
  border-radius:12px;
  padding:16px;
  overflow:auto;
  max-height:70vh;
  font-size:13px;
  line-height:1.4;
}

.status{
  margin:10px 0;
  color:#93a4b7;
}
.elapsed{
  color:#22d3ee;
  margin-top:6px;
  font-size:13px;
}
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" placeholder="Password" type="password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="elapsed" id="elapsed"></div>

  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL=`${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL=`${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;

const SHIP_URL=`${BASE}/fms-platform-order/shipment-orders/queryOrderLog`;

const $=id=>document.getElementById(id);

let TOKEN=null;

/* =======================
   AUTH ‚Äì UNCHANGED
======================= */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in...";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client":CLIENT,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;

  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

/* =======================
   API HELPER ‚Äì UNCHANGED
======================= */
async function api(url, method="GET", body=null){
  const t = await auth();

  const opts={
    method,
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  };

  if(body) opts.body = JSON.stringify(body);

  const r = await fetch(url,opts);

  if(!r.ok) throw new Error(`HTTP ${r.status}`);

  return r.json();
}

/* =======================
   FILTER HELPERS
======================= */

// keeps ONLY dispatch / undispatch related shipment events
function isRelevantShipmentEvent(text){
  if(!text) return false;
  const t=text.toLowerCase();
  return t.includes("dispatch")
      || t.includes("pickup")
      || t.includes("linehaul");
}

// shorten long shipment descriptions
function cleanShipmentDesc(desc){
  const m = desc.match(/Event\s+\[.+?\]\s+Changed Order Status From\s+\[.*?\]\s+to\s+\[.*?\]/i);
  if(m) return m[0];
  return desc.split(".")[0];
}

// match shipment event to trip dispatch by timestamp (¬±2s)
function matchTimes(t1,t2){
  const a = new Date(t1).getTime();
  const b = new Date(t2).getTime();
  return Math.abs(a-b) <= 2000;
}

/* =======================
   MAIN AUDIT
======================= */

async function audit(){

  $("out").textContent="";
  $("elapsed").textContent="";
  $("status").textContent="Running...";

  TOKEN=null;

  const start = Date.now();

  try{

    const tripNo = $("trip").value.trim();
    if(!tripNo) throw new Error("Trip # required");

    /* ---- TASK MAP ---- */
    $("status").textContent="Fetching Task List...";
    const tasks = await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};

    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no||!t.tracking_no) return;

      MAP[t.task_no]={
        PRO:t.tracking_no,
        DO:t.shipment_order_no||t.order_no||"",
        PU:t.pu_no||""
      };
    });

    /* ---- TRIP HISTORY ---- */
    $("status").textContent="Fetching Trip History...";
    const hist = await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    let perPRO={};

    (hist?.data?.trip_history_list||[]).forEach(e=>{
      if(!MAP[e.task_no]) return;

      // only dispatch / undispatch from trip history
      if(!/dispatch/i.test(e.event_description)) return;

      const m=MAP[e.task_no];

      if(!perPRO[m.PRO]){
        perPRO[m.PRO]={
          PRO:m.PRO,
          DO:m.DO,
          PU:m.PU,
          events:[]
        };
      }

      perPRO[m.PRO].events.push({
        time:e.time,
        desc:e.event_description,
        user:e.user,
        source:"trip"
      });
    });

    /* ---- SHIPMENT HISTORY ---- */
    $("status").textContent="Fetching Shipment History...";

    for(const pro of Object.keys(perPRO)){

      const entry=perPRO[pro];
      if(!entry.DO) continue;

      let ship;

      /* GET will 405 ‚Äì so fallback to POST */
      try{
        ship = await api(`${SHIP_URL}?orderNo=${entry.DO}`);
      }catch{
        ship = await api(SHIP_URL,"POST",{orderNo:entry.DO});
      }

      const evs = ship?.data?.list || [];

      evs.forEach(s=>{

        if(!isRelevantShipmentEvent(s.event)) return;

        // try to match this shipment log to a trip log time
        let matched=false;

        entry.events.forEach(t=>{
          if(matchTimes(t.time,s.event_time)){
            t.matched = true;
            matched = true;
          }
        });

        if(!matched) return;

        entry.events.push({
          time:s.event_time,
          desc:cleanShipmentDesc(s.event),
          user:"",
          source:"shipment"
        });
      });
    }

    /* ---- OUTPUT ---- */

    $("status").textContent="Rendering...";

    let out="";

    for(const pro of Object.keys(perPRO).sort()){

      const o=perPRO[pro];

      out+=`PRO ${pro}\n`;
      out+=`DO  ${o.DO||"-"}\n`;
      out+=`PU  ${o.PU||"-"}\n`;

      o.events.sort((a,b)=>new Date(a.time)-new Date(b.time));

      o.events.forEach(e=>{
        out+=`  ${e.time} | ${e.source==="shipment"?"Event ":""}${e.desc}${e.user?` (${e.user})`:""}\n`;
      });

      out+="--------------------------------------------\n";
    }

    if(!out) out="No matching events found.";

    $("out").textContent = out;

    const elapsed = ((Date.now()-start)/1000).toFixed(2);
    $("elapsed").textContent=`Elapsed: ${elapsed}s`;

    $("status").textContent="‚úÖ Audit Complete";

  }catch(e){

    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
    console.error(e);

  }

}

/* ---- UI ---- */
$("run").addEventListener("click",audit);

})();
</script>
</body>
</html>
