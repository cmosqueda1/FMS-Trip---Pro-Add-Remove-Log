<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}
*{box-sizing:border-box}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 15px 0;
  font-size:26px;
}

.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}

.pw-wrap{
  position:relative;
}
.pw-wrap input{
  width:190px;
}
.pw-eye{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  width:20px;
  height:20px;
  fill:white;
  color:white;
  opacity:0.9;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
  width:190px;
}

button{
  cursor:pointer;
  border:none;
  border-radius:12px;
  padding:10px 18px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;
  font-weight:700;
  font-size:14px;
}

.status{
  color:var(--muted);
  margin:8px 0 6px;
}
.timer{
  color:#22d3ee;
  font-size:13px;
}

pre{
  background:#070b14;
  border-radius:12px;
  padding:16px;
  overflow:auto;
  max-height:70vh;
  font-size:13px;
  border:1px solid var(--border);
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">

    <div class="pw-wrap">
      <input id="pass" placeholder="Password" type="password">
      <svg class="pw-eye" id="pwToggle" viewBox="0 0 24 24">
        <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10zm0-8a3 3 0 100 6 3 3 0 000-6z"/>
      </svg>
    </div>

    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="timer" id="timer"></div>

  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{
const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL   = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL   = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL    = `${BASE}/fms-platform-order/shipment-order-history/`;
const SEARCH_URL  = `${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

const $ = id => document.getElementById(id);

let TOKEN=null;
let timerInt=null;

/* password toggle */
$("pwToggle").addEventListener("click",()=>{
  const p=$("pass");
  p.type = p.type==="password" ? "text" : "password";
});

/* login */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j=await r.json();
  TOKEN=j.token || j?.data?.token;
  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

/* API helper */
async function api(url){
  const t=await auth();
  const r=await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* normalize DO prefix */
function normalizeDO(val){
  if(!val) return "";
  val = String(val).trim();
  if(val.toUpperCase().startsWith("DO")) return val;
  const digits = val.replace(/[^0-9]/g,"");
  return digits ? "DO"+digits : val;
}

/* extract PRO from description */
function extractPRO(desc){
  const m = desc.match(/pro[#\s]*([0-9]+)/i);
  return m ? m[1] : "";
}

/* shipment event formatter */
function extractShipmentEvent(e){
  if(!e?.event?.toLowerCase().includes("changed order status")) return null;
  return {
    time:e.event_time || "",
    text:e.event.split("].")[0] + "]"
  };
}

/* undispatch detector including "removed" */
function looksLikeUnDispatched(desc){
  const d = desc.toLowerCase();
  return (
    d.includes("undispatch") ||
    d.includes("un-dispatch") ||
    d.includes("un dispatch") ||
    d.includes("removed")
  );
}

/* lookup DO from PRO via /search-all */
async function lookupDO(PRO){
  try{
    const res = await api(SEARCH_URL + PRO);
    const order = res?.data?.orders?.[0]?.order_no || "";
    return normalizeDO(order);
  }catch{
    return "";
  }
}

/* main */
async function audit(){
  $("out").textContent="";
  $("status").textContent="Starting‚Ä¶";
  $("timer").textContent="";
  TOKEN=null;

  const tripNo=$("trip").value.trim();
  if(!tripNo) return alert("Trip # required");

  const start=Date.now();
  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);

  try{
    /* tasks */
    $("status").textContent="Fetching tasks‚Ä¶";
    const tasksRes=await api(`${TASKS_URL}?tripNo=${tripNo}`);
    const MAP={};

    (tasksRes?.data||[]).forEach(t=>{
      if(!t.task_no) return;
      MAP[t.task_no]={
        PRO:t.tracking_no||"",
        DO:normalizeDO(t.shipment_order_no||t.order_no||""),
        PU:t.pu_no||""
      };
    });

    /* trip history */
    $("status").textContent="Fetching trip history‚Ä¶";
    const histRes=await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const perBucket={};
    const trips = histRes?.data?.trip_history_list || [];

    for(const ev of trips){
      const raw = ev.event_description || "";
      const low = raw.toLowerCase();

      const isDispatch   = low.includes("dispatched");
      const isUnDispatch = looksLikeUnDispatched(raw);

      if(!isDispatch && !isUnDispatch) continue;

      let mapped = ev.task_no ? MAP[ev.task_no] : null;
      let PRO = mapped?.PRO || "";
      let DO  = mapped?.DO  || "";
      let PU  = mapped?.PU  || "";

      /* fallback PRO from text */
      if(!PRO){
        const p = extractPRO(raw);
        if(p) PRO=p;
      }

      /* fallback DO from event.order_no */
      if(!DO && ev.order_no){
        DO = normalizeDO(ev.order_no);
      }

      /* if still no DO but PRO is known -> search-all */
      if(!DO && PRO){
        DO = await lookupDO(PRO);
      }

      const key = PRO || DO || "(none)";
      if(!perBucket[key]){
        perBucket[key]={
          PRO:PRO||"(none)",
          DO:DO||"-",
          PU:PU||"-",
          events:[]
        };
      }else{
        if(DO && perBucket[key].DO === "-"){
          perBucket[key].DO = DO;
        }
        if(PRO && perBucket[key].PRO === "(none)"){
          perBucket[key].PRO = PRO;
        }
      }

      perBucket[key].events.push({
        type:"trip",
        time:ev.time,
        displayTime:ev.time,
        text:raw,
        user:ev.user||""
      });
    }

    /* match shipment events */
    $("status").textContent="Matching shipment events‚Ä¶";

    for(const key of Object.keys(perBucket)){
      const rec = perBucket[key];
      const DO  = rec.DO && rec.DO !== "-" ? rec.DO : "";

      if(!DO){
        /* no DO at all -> still add placeholder per trip event */
        const additions=[];
        rec.events.forEach(ev=>{
          additions.push({
            type:"ship",
            time:ev.time,
            displayTime:"",
            text:"‚Äî No shipment event ‚Äî",
            user:""
          });
        });
        rec.events = rec.events.concat(additions);
        continue;
      }

      const shipRes = await api(SHIP_URL + DO);
      const shipEvents = shipRes?.data || [];
      const additions=[];

      rec.events.forEach(ev=>{
        let best=null;

        shipEvents.forEach(se=>{
          const sx = extractShipmentEvent(se);
          if(!sx) return;
          const diff = Math.abs(new Date(ev.time) - new Date(sx.time));
          if(!best || diff < best.diff){
            best={diff, ev:sx};
          }
        });

        if(best){
          additions.push({
            type:"ship",
            time:best.ev.time,
            displayTime:"",
            text:best.ev.text,
            user:""
          });
        }else{
          additions.push({
            type:"ship",
            time:ev.time,
            displayTime:"",
            text:"‚Äî No shipment event ‚Äî",
            user:""
          });
        }
      });

      rec.events = rec.events.concat(additions);

      /* sort by real time; trip above ship when equal */
      rec.events.sort((a,b)=>{
        const ta = a.time ? new Date(a.time).getTime() : 0;
        const tb = b.time ? new Date(b.time).getTime() : 0;
        if(ta === tb){
          return a.type === "trip" ? -1 : 1;
        }
        return ta - tb;
      });
    }

    clearInterval(timerInt);
    $("status").textContent="‚úî Audit complete";

    /* output */
    let out="";
    Object.keys(perBucket).forEach(key=>{
      const r = perBucket[key];

      out+=`PRO ${r.PRO}\n`;
      out+=`DO  ${r.DO}\n`;
      out+=`PU  ${r.PU}\n`;

      r.events.forEach(ev=>{
        const ts = ev.displayTime ? ev.displayTime : " ".repeat(19);
        out+=`  ${ts} | ${ev.text}${ev.user?` (${ev.user})`:""}\n`;
      });

      out+="--------------------------------------------\n";
    });

    $("out").textContent = out || "No dispatch/undispatch events found.";

  }catch(e){
    clearInterval(timerInt);
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
    console.error(e);
  }
}

/* run button */
$("run").addEventListener("click", audit);

})();
</script>

</body>
</html>
