<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FMS Trip Change Audit Bot</title>
<style>
body{
  margin:0; padding:30px;
  background:#070b14;
  font-family:system-ui,Segoe UI,Arial;
  color:#e6edff;
}
.container{
  max-width:900px;
  margin:auto;
  padding:22px;
  background:linear-gradient(135deg,#0d1423,#111b30);
  border-radius:18px;
  box-shadow:0 0 40px rgba(0,0,0,.45);
}
h1{
  margin-top:0;
  font-size:22px;
}
.row{
  display:flex;
  gap:12px;
  margin-bottom:14px;
}
input{
  flex:1;
  background:#090f1c;
  border:1px solid #253047;
  border-radius:8px;
  color:#fff;
  padding:10px 12px;
}
button{
  background:linear-gradient(135deg,#7c3aed,#06b6d4);
  border:0;
  padding:11px 20px;
  border-radius:10px;
  color:#fff;
  cursor:pointer;
}
#status{
  margin-top:10px;
  color:#7dd3fc;
}
#out{
  margin-top:20px;
  background:#060b17;
  border-radius:12px;
  padding:14px;
  font-family:Consolas,monospace;
  font-size:13px;
  white-space:pre-wrap;
  overflow-y:auto;
  max-height:480px;
}
.proBlock{
  margin-bottom:16px;
  border-bottom:1px solid #1f2937;
  padding-bottom:12px;
}
</style>
</head>
<body>

<div class="container">
<h1>ðŸšš FMS Trip Change Audit Bot</h1>

<div class="row">
  <input id="user" placeholder="Username">
  <input id="pass" placeholder="Password" type="password">
  <input id="trip" placeholder="Trip #">
  <button id="run">Run Audit</button>
</div>

<div id="status">Idle</div>
<div id="out"></div>

</div>

<script>
const BASE = "https://fms.item.com";

const LOGIN   = BASE+"/fms-platform-user/Auth/Login";
const TRIPLOG = BASE+"/fms-platform-dispatch-management/trip-history/query";
const SHIPLOG = BASE+"/fms-platform-order/shipment-orders/queryOrderLog";

let TOKEN = "";

document.getElementById("run").onclick = runAudit;

async function runAudit(){
  const u=document.getElementById("user").value;
  const p=document.getElementById("pass").value;
  const t=document.getElementById("trip").value;

  if(!u||!p||!t){
    alert("Fill all fields");
    return;
  }

  set("Logging in...");
  await login(u,p);

  set("Loading trip history...");
  const tripEvents = await getTripHistory(t);

  if(!tripEvents.length){
    set("No trip events found.");
    return;
  }

  set("Loading shipment history...");
  const shipEvents = await getShipmentHistory(t);

  set("Matching & building output...");
  const report = matchEvents(tripEvents, shipEvents);

  render(report);
  set(`Complete â€” ${report.length} matches`);
}

function set(msg){
  document.getElementById("status").innerText=msg;
}

async function login(u,p){
  const r = await fetch(LOGIN,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({username:u,password:p})
  });
  const j = await r.json();
  TOKEN=j.data.token;
}

async function getTripHistory(trip){
  const r = await fetch(TRIPLOG,{
    method:"POST",
    headers:{
      "Authorization":TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({trip_no:trip})
  });
  const j=await r.json();

  return j.data.trip_history_list.filter(x=>{
    return /Dispatched|Undispatched/i.test(x.event_description);
  });
}

async function getShipmentHistory(trip){
  const r = await fetch(SHIPLOG,{
    method:"POST",
    headers:{
      "Authorization":TOKEN,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({tripNo:trip})
  });
  const j=await r.json();
  return j.data||[];
}

// ----------------------------------------------------

function extractPRO(t){
  const m = t.match(/PRO#?\s*(\d{5,10})/i);
  return m?m[1]:null;
}

function shortenShipment(text){
  const m = text.match(/Event\s*\[[^\]]+\].*?to\s*\[[^\]]+\]/i);
  return m?m[0]:"Shipment event";
}

function matchEvents(trip, ship){

  const results=[];

  trip.forEach(tEvt=>{

    const pro = extractPRO(tEvt.event_description);
    if(!pro) return;

    const tTime=new Date(tEvt.time).getTime();

    const matches = ship.filter(s=>{
      return (
        /Changed Order Status|PickupTaskDispatched|LinehaulTaskDispatched|UnDispatched/i.test(s.event||"")
        && s.event.includes(pro)
      );
    });

    let best=null;
    let bestDiff=Infinity;

    matches.forEach(m=>{
      const sTime = new Date(m.event_time).getTime();
      const d = Math.abs(tTime-sTime);
      if(d<bestDiff){
        bestDiff=d;
        best=m;
      }
    });

    results.push({
      pro,
      trip:tEvt,
      ship:best
    });

  });

  return results;
}

function render(rows){
  const out=document.getElementById("out");
  out.innerHTML="";

  if(!rows.length){
    out.innerText="No matching dispatch events found.";
    return;
  }

  rows.forEach(r=>{

    const d=document.createElement("div");
    d.className="proBlock";

    let txt=`PRO ${r.pro}\n`;
    txt+=`${r.trip.time} | ${r.trip.event_description}\n`;

    if(r.ship){
      txt+=`${r.ship.event_time} | ${shortenShipment(r.ship.event)}\n`;
    }else{
      txt+=`(No shipment status-change event found)\n`;
    }

    d.innerText=txt;
    out.appendChild(d);
  });
}
</script>
</body>
</html>
