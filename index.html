<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 15px 0;
  font-size:26px;
}

.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
  width:190px;
}

input[type="password"]{
  padding-right:42px;
}

/* ===== PASSWORD TOGGLE VISIBILITY FIX ===== */
input[type="password"]::-ms-reveal,
input[type="password"]::-ms-clear{
  filter:invert(1) brightness(1.6);
}

::-webkit-textfield-decoration-container{
  filter:invert(1) brightness(1.6);
  scale:1.25;
}

button{
  cursor:pointer;
  border:none;
  border-radius:12px;
  padding:10px 18px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;
  font-weight:700;
  font-size:14px;
}

.status{
  color:var(--muted);
  margin:8px 0 6px;
}

.timer{
  color:#22d3ee;
  font-size:13px;
}

pre{
  background:#070b14;
  border-radius:12px;
  padding:16px;
  overflow:auto;
  max-height:70vh;
  font-size:13px;
  border:1px solid var(--border);
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="wrap">

<h1>ðŸšš FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" placeholder="Password" type="password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="timer" id="timer"></div>

  <pre id="out"></pre>
</div>

</div>

<script>
(()=>{
const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL   = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL   = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL    = `${BASE}/fms-platform-order/shipment-order-history/`;

const $ = id => document.getElementById(id);

let TOKEN=null;
let timerInt=null;

/* ================= AUTH ================= */
async function auth(){
    if(TOKEN) return TOKEN;

    $("status").textContent="Logging inâ€¦";

    const r = await fetch(LOGIN_URL,{
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "fms-client":CLIENT
        },
        body:JSON.stringify({
            account:$("user").value.trim(),
            password:$("pass").value.trim()
        })
    });

    if(!r.ok) throw new Error("Login failed");

    const j = await r.json();
    TOKEN = j.token || j?.data?.token;

    if(!TOKEN) throw new Error("Token missing");

    return TOKEN;
}

/* ================= API ================= */
async function api(url){
    const t = await auth();

    const r = await fetch(url,{
        headers:{
            "accept":"application/json",
            "Content-Type":"application/json",
            "fms-client":CLIENT,
            "fms-token":t
        }
    });

    if(!r.ok) throw new Error(`HTTP ${r.status}`);

    return r.json();
}

/* ================= TIMER ================= */
function startTimer(){
    const start=Date.now();
    timerInt = setInterval(()=>{
        const s=((Date.now()-start)/1000).toFixed(2);
        $("timer").textContent=`Elapsed: ${s}s`;
    },100);
}

function stopTimer(){
    if(timerInt) clearInterval(timerInt);
}

/* ================= DISPATCH EVENT FILTER ================= */
function extractStatusEvent(e){
    if(!e || !e.event) return null;
    // Keep only true status-change events
    if(!e.event.includes("Changed Order Status")) return null;

    const short = e.event.split("].")[0] + "]";
    return {
        time:e.event_time,
        text:short,
        user:e.user_name || ""
    };
}

/* ================= MAIN ================= */
async function audit(){

    $("out").textContent="";
    $("timer").textContent="";
    $("status").textContent="Startingâ€¦";

    TOKEN=null;
    startTimer();

    try{

        const tripNo=$("trip").value.trim();
        if(!tripNo) throw new Error("Trip # required");

        /* ---------- TASK MAP ---------- */
        $("status").textContent="Fetching tasksâ€¦";
        const tasks = await api(`${TASKS_URL}?tripNo=${tripNo}`);

        const MAP={};

        (tasks?.data||[]).forEach(t=>{
            if(!t.task_no || !t.tracking_no) return;

            MAP[t.task_no]={
                PRO:t.tracking_no,
                DO:t.shipment_order_no || t.order_no || "",
                PU:t.pu_no || ""
            };
        });

        /* ---------- TRIP HISTORY ---------- */
        $("status").textContent="Fetching trip historyâ€¦";
        const hist = await api(`${HISTORY_URL}?tripNo=${tripNo}`);

        let perPRO={};

        (hist?.data?.trip_history_list||[]).forEach(h=>{
            const m=MAP[h.task_no];
            if(!m) return;

            if(!perPRO[m.PRO]){
                perPRO[m.PRO]={
                    PRO:m.PRO,
                    DO:m.DO,
                    PU:m.PU,
                    tripEvt:null,
                    shipEvt:null
                };
            }

            if(h.event_description.includes("Dispatched")){
                perPRO[m.PRO].tripEvt={
                    time:h.time,
                    text:h.event_description,
                    user:h.user || ""
                };
            }
        });

        /* ---------- SHIPMENT HISTORY MATCHER ---------- */
        $("status").textContent="Matching shipment historyâ€¦";

        for(const pro of Object.keys(perPRO)){
            const o=perPRO[pro];
            if(!o.DO) continue;

            const ship = await api(SHIP_URL+o.DO);
            const arr = ship?.data||[];

            let best=null;

            arr.forEach(ev=>{
                const s=extractStatusEvent(ev);
                if(!s) return;

                const t0=new Date(o.tripEvt.time).getTime();
                const t1=new Date(s.time).getTime();

                const diff=Math.abs(t1-t0);

                if(!best || diff < best.diff){
                    best={ev:s,diff};
                }
            });

            if(best) o.shipEvt=best.ev;
        }

        /* ---------- OUTPUT ---------- */
        $("status").textContent="Renderingâ€¦";
        stopTimer();

        let out="";

        for(const pro of Object.keys(perPRO).sort()){
            const o=perPRO[pro];

            out+=`PRO ${o.PRO}\n`;
            out+=`DO  ${o.DO}\n`;
            out+=`PU  ${o.PU || "-"}\n`;

            if(o.tripEvt){
                out+=`  ${o.tripEvt.time} | ${o.tripEvt.text} (${o.tripEvt.user})\n`;
            }

            if(o.shipEvt){
                out+=`  ${o.shipEvt.time} | ${o.shipEvt.text}\n`;
            }

            out+="--------------------------------------------\n";
        }

        $("out").textContent = out || "No matching events found.";
        $("status").textContent="âœ… Audit complete";

    }catch(e){
        stopTimer();
        $("status").textContent="âŒ Error";
        $("out").textContent=e.message;
        console.error(e);
    }
}

/* ================= UI ================= */
$("run").addEventListener("click",audit);

})();
</script>

</body>
</html>
