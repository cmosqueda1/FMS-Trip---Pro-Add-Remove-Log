<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üöö FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#0a0c10;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2a3a;
  --ok:#10b981;
  --bad:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  padding:24px;
}
h1{margin:0 0 12px}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
input,button{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
}
button{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none;
  font-weight:700;
  cursor:pointer;
}
button:hover{opacity:.95}
pre{
  background:#0b0f19;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  font-size:13px;
  overflow:auto;
  white-space:pre-wrap;
}
.log-ok{color:var(--ok)}
.log-bad{color:var(--bad)}
.log-muted{color:var(--muted)}
.sep{color:var(--muted)}
</style>
</head>
<body>

<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="row">
  <input id="user" placeholder="FMS Username" style="width:180px"/>
  <input id="pass" type="password" placeholder="Password" style="width:180px"/>
  <input id="trip" placeholder="Trip #" style="width:140px"/>
  <button onclick="runAudit()">Run Audit</button>
</div>

<pre id="log"></pre>

<script>

const logEl = document.getElementById("log");

function log(msg, cls=""){
  logEl.innerHTML += cls ? `<span class="${cls}">${msg}</span>\n` : msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

async function api(url, method="GET", body=null, token=null){
  const opts={
    method,
    credentials:"include",
    headers:{
      "content-type":"application/json",
      "accept":"application/json,text/plain,*/*"
    }
  };
  if(token) opts.headers["fms-token"]=token;
  if(body) opts.body=JSON.stringify(body);

  const res = await fetch(url, opts);
  if(!res.ok){
    throw new Error(`${res.status} ${res.statusText}`);
  }
  return res.json();
}

let FMS_TOKEN=null;

/* ================= LOGIN ================= */

async function login(u,p){
  log("üîê Logging in...");
  const res = await api(
    "https://fms.item.com/fms-platform-user/Auth/Login",
    "POST",
    { username:u, password:p }
  );

  FMS_TOKEN = res?.data?.token || res?.token;

  if(!FMS_TOKEN) throw new Error("AUTH_FAILED");
  log("‚úÖ Authenticated","log-ok");
}

/* ================= TASK LIST ================= */

async function getTaskList(trip){
  log("üì¶ Loading task map...");
  const j = await api(
    `https://fms.item.com/fms-platform-dispatch-management/TripDetail/GetTaskList?tripNo=${trip}`,
    "GET",
    null,
    FMS_TOKEN
  );

  const map={};

  j.data.forEach(t=>{
    map[t.task_no]={
      pro: t.tracking_no || "‚Äî",
      do: t.shipment_order_no || t.order_no || "‚Äî",
      pu: t.pu_no || "‚Äî",
    };
  });

  log(`‚úÖ Tasks indexed: ${Object.keys(map).length}`);
  return map;
}

/* ================= TRIP HISTORY ================= */

async function getTripHistory(trip){
  log("üìÑ Fetching trip history...");
  const j = await api(
    `https://fms.item.com/fms-platform-dispatch-management/TripDetail/GetTripHistoryList?tripNo=${trip}`,
    "GET",
    null,
    FMS_TOKEN
  );
  log(`‚úÖ Raw trip events: ${j.data.trip_history_list.length}`);
  return j.data.trip_history_list;
}

/* ================= SHIPMENT HISTORY ================= */

async function getShipmentHistory(doNo){
  if(!doNo || doNo==="‚Äî") return [];

  try{
    const j = await api(
      `https://fms.item.com/fms-platform-order/shipment-order-history/${doNo}`,
      "GET",
      null,
      FMS_TOKEN
    );
    return j?.data || [];
  }catch(e){
    log(`‚ö† Failed shipment history for ${doNo}`,"log-bad");
    return [];
  }
}

/* ================= AUDIT ================= */

async function runAudit(){
  try{
    logEl.innerHTML="";

    const u=user.value.trim();
    const p=pass.value.trim();
    const t=trip.value.trim();

    if(!u||!p||!t){
      alert("Enter login + trip number");
      return;
    }

    await login(u,p);

    const taskMap = await getTaskList(t);
    const history = await getTripHistory(t);

    const proMap = {};

    history.forEach(ev=>{
      const task = ev.task_no;
      if(!taskMap[task]) return;

      const ref = taskMap[task];
      const pro = ref.pro;

      if(!proMap[pro]){
        proMap[pro] = {
          pro,
          do: ref.do,
          pu: ref.pu,
          events:[]
        };
      }

      proMap[pro].events.push({
        time: ev.time,
        user: ev.user || "System",
        desc: ev.event_description
      });
    });

    log(`üìå Impacted PROs: ${Object.keys(proMap).length}\n`);

    /* ================= OUTPUT ================= */

    for(const pKey of Object.keys(proMap)){
      const R = proMap[pKey];

      log(`PRO ${R.pro}`);
      log(`DO ${R.do}`);
      log(`PU ${R.pu}\n`);

      R.events
        .sort((a,b)=>new Date(a.time)-new Date(b.time))
        .forEach(e=>{
          log(`  ${e.time} ‚Äî ${e.user}`);
          log(`      ${e.desc}`,"log-muted");
        });

      const shipHist = await getShipmentHistory(R.do);

      if(shipHist.length){
        log("  [Shipment Status Changes]");
        shipHist
          .sort((a,b)=>new Date(a.create_time)-new Date(b.create_time))
          .forEach(s=>{
            log(`    ${s.create_time} ‚Üí ${s.status_text}`);
          });
      }

      log("\n------------------------------\n","sep");
    }

    log("‚úÖ AUDIT COMPLETE","log-ok");

  }catch(err){
    console.error(err);
    log("‚ùå ERROR","log-bad");
    log(err.message || err.toString(),"log-bad");
  }
}

</script>
</body>
</html>
