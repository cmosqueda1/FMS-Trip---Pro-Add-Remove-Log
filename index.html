<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 15px 0;
  font-size:26px;
}

.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
  width:190px;
}

button{
  cursor:pointer;
  border:none;
  border-radius:12px;
  padding:10px 18px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;
  font-weight:700;
  font-size:14px;
}

.status{
  color:var(--muted);
  margin:8px 0 6px;
}

.timer{
  color:#22d3ee;
  font-size:13px;
}

pre{
  background:#070b14;
  border-radius:12px;
  padding:16px;
  overflow:auto;
  max-height:70vh;
  font-size:13px;
  border:1px solid var(--border);
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="timer" id="timer"></div>

  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{
/* ===========================================================
   CONFIG
=========================================================== */

const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL   = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL   = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL    = `${BASE}/fms-platform-order/shipment-order-history/`;
const ORDER_BASIC_URL = `${BASE}/fms-platform-order/shipper/getshipment-orderbasic/`;
const SEARCH_URL  = `${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

const $ = id => document.getElementById(id);

let TOKEN=null;
let timerInt=null;

/* ===========================================================
   AUTH
=========================================================== */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;
  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

/* ===========================================================
   API
=========================================================== */
async function api(url){
  const t = await auth();
  const r = await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* ===========================================================
   TIMER
=========================================================== */
function startTimer(){
  const start=Date.now();
  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);
}
function stopTimer(){ clearInterval(timerInt); }

/* ===========================================================
   SHIPMENT EVENT PARSER (truncate to first sentence)
=========================================================== */
function extractStatusEvent(e){
  if(!e?.event?.includes("Changed Order Status")) return null;
  return {
    time:e.event_time,
    text:e.event.split(".")[0].trim()
  };
}

/* ===========================================================
   FALLBACK: ORDERBASIC PARSER
=========================================================== */
function extractFallbackEvent(orderBasic, taskNo){
  if(!orderBasic?.reference_outputs) return null;

  // Find record matching task_no
  const rec = orderBasic.reference_outputs.find(x => String(x.task_no) === String(taskNo));
  if(!rec) return null;

  // We need before/after states.
  // reference_outputs is sorted by sequence, so sequence-1 is before-state.
  const all = orderBasic.reference_outputs.sort((a,b)=>a.sequence - b.sequence);
  
  const idx = all.findIndex(x => String(x.task_no) === String(taskNo));
  if(idx < 0) return null;

  const curr = all[idx];
  const prev = all[idx-1];

  const before = prev?.status_text || "Unknown";
  const after  = curr?.status_text || curr?.status || "Unknown";

  // Build FMS-style Undispatch event
  return `Event [PickupTaskUnDispatched] Changed Order Status From [${before}] to [${after}]`;
}

/* ===========================================================
   DO LOOKUP
=========================================================== */
async function resolveDOFromPRO(pro){
  try{
    const s=await api(SEARCH_URL+pro);
    return s?.data?.orders?.[0]?.order_no || null;
  }catch{return null;}
}

/* ===========================================================
   MAIN AUDIT
=========================================================== */
async function audit(){
  $("out").textContent="";
  $("timer").textContent="";
  $("status").textContent="Starting‚Ä¶";

  TOKEN=null;
  startTimer();

  try{

    const tripNo=$("trip").value.trim();
    if(!tripNo) throw new Error("Trip # required");

    /* -------------------------------------------------------
       FETCH TASKS
    ------------------------------------------------------- */
    $("status").textContent="Fetching tasks‚Ä¶";
    const tasks=await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};
    (tasks?.data||[]).forEach(t=>{
      MAP[t.task_no] = {
        PRO:t.tracking_no||"",
        DO:t.shipment_order_no||t.order_no||"",
        PU:t.pu_no||""
      };
    });

    /* -------------------------------------------------------
       FETCH TRIP HISTORY
    ------------------------------------------------------- */
    $("status").textContent="Fetching trip history‚Ä¶";
    const h=await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const perPRO={};

    const isDispatchEvent = desc => desc.includes("dispatch");  

    (h?.data?.trip_history_list||[]).forEach(ev=>{
      const desc = ev.event_description?.toLowerCase() || "";
      if(!isDispatchEvent(desc)) return;

      // Extract TaskID if missing
      if(!ev.task_no){
        const m = ev.event_description.match(/TaskID:(\d+)/);
        if(m) ev.task_no = m[1];
      }

      const task = MAP[ev.task_no] || {PRO:"",DO:"",PU:""};

      const pro = task.PRO;
      const doNum = task.DO;
      const puNum = task.PU;

      if(!perPRO[pro]){
        perPRO[pro]={
          PRO:pro,
          DO:doNum,
          PU:puNum,
          events:[]
        };
      }

      perPRO[pro].events.push({
        taskNo:ev.task_no,
        trip:{
          time:ev.time,
          text:ev.event_description,
          user:ev.user||""
        },
        ship:null
      });
    });

    /* -------------------------------------------------------
       MATCH SHIPMENT EVENTS + FALLBACK
    ------------------------------------------------------- */
    $("status").textContent="Matching shipment history‚Ä¶";

    for(const pro of Object.keys(perPRO)){
      const record=perPRO[pro];

      if(!record.DO){
        record.DO = await resolveDOFromPRO(pro);
      }
      if(!record.DO) continue;

      const shipData = await api(SHIP_URL+record.DO);

      const timeline = (shipData?.data||[])
        .map(x=>extractStatusEvent(x))
        .filter(Boolean)
        .sort((a,b)=> new Date(a.time) - new Date(b.time));

      // Load fallback data once
      let fallbackData = null;

      record.events.forEach(async evt=>{
        const tripTime = new Date(evt.trip.time).getTime();

        const next = timeline.find(se =>
          new Date(se.time).getTime() >= tripTime
        );

        if(next){
          evt.ship = next;
        } else {
          // Need fallback from orderbasic
          if(!fallbackData){
            fallbackData = await api(ORDER_BASIC_URL + record.DO);
          }
          const fb = extractFallbackEvent(fallbackData.data, evt.taskNo);
          if(fb) evt.ship = { text: fb };
        }
      });
    }

    /* -------------------------------------------------------
       OUTPUT
    ------------------------------------------------------- */
    stopTimer();
    $("status").textContent="‚úî Audit complete";

    let out="";

    Object.keys(perPRO).sort().forEach(p=>{
      const o=perPRO[p];

      out+=`PRO ${o.PRO || "(none)"}\n`;
      out+=`DO  ${o.DO||"-"}\n`;
      out+=`PU  ${o.PU||"-"}\n`;

      o.events.forEach(ev=>{
        out+=`  ${ev.trip.time} | ${ev.trip.text} (${ev.trip.user})\n`;
        if(ev.ship){
          out+=`  ${ev.ship.text}\n`;
        } else {
          out+=`  ‚Äî No subsequent shipment event ‚Äî\n`;
        }
      });

      out+="--------------------------------------------\n";
    });

    $("out").textContent = out;

  }catch(e){
    stopTimer();
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
    console.error(e);
  }
}

/* -------------------------------------------------------
   UI HOOK
------------------------------------------------------- */
$("run").addEventListener("click", audit);

})();
</script>

</body>
</html>
