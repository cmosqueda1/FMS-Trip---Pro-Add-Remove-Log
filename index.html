<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
  body{
    margin:0;
    background:#05070b;
    color:#e6edf6;
    font-family:Inter,system-ui,Arial;
  }
  .wrap{max-width:1100px;margin:40px auto;padding:20px;}
  h1{margin-top:0}
  input,button{
    background:#0b0f19;
    color:#e6edf6;
    border:1px solid #1f2933;
    border-radius:10px;
    padding:10px 14px;
    font-size:14px;
  }
  button{
    cursor:pointer;
    background:linear-gradient(90deg,#7c3aed,#22d3ee);
    border:none;
    color:#05070b;
    font-weight:700;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
  .card{
    background:#0f1420;
    border:1px solid #1f2933;
    border-radius:16px;
    padding:16px;
  }
  pre{
    background:#0b0f19;
    border-radius:12px;
    padding:16px;
    overflow:auto;
    max-height:70vh;
    font-size:13px;
  }
  .status{margin:10px 0;color:#93a4b7;}
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <input id="user" placeholder="Username">
    <input id="pass" placeholder="Password" type="password">
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>
  <div class="status" id="status">Idle</div>
  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

const BASE = "https://fms.item.com";
const CLIENT = "FMS_WEB";

const LOGIN_URL        = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL        = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL      = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_HISTORY_URL = `${BASE}/fms-platform-order/shipment-order-history/`;

const $ = id => document.getElementById(id);
let TOKEN = null;

/* ---------- AUTH (same as your working version) ---------- */

async function auth(){
  if (TOKEN) return TOKEN;

  $("status").textContent = "Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client": CLIENT,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      account: $("user").value.trim(),
      password: $("pass").value.trim()
    })
  });

  if (!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;
  if (!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

async function api(url){
  const t = await auth();
  const r = await fetch(url,{
    method:"GET",
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client": CLIENT,
      "fms-token": t
    }
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* ---------------------- MAIN AUDIT ---------------------- */

async function audit(){

  $("out").textContent = "";
  TOKEN = null; // fresh login each run, same as before

  try{
    const tripNo = $("trip").value.trim();
    if (!tripNo) throw new Error("Trip # required");

    /* 1) Task list ‚Üí map task_no ‚Üí {PRO, DO, PU} */
    $("status").textContent = "Fetching Task List‚Ä¶";
    const tasks = await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP = {};
    (tasks?.data?.tasks || []).forEach(t=>{
      if (!t.task_no || !t.tracking_no) return;
      MAP[t.task_no] = {
        PRO: t.tracking_no,
        DO : t.shipment_order_no || t.order_no || "",
        PU : t.pu_no || ""
      };
    });

    /* 2) Trip History ‚Üí per PRO events (EXACTLY your working logic) */
    $("status").textContent = "Fetching Trip History‚Ä¶";
    const hist = await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    let perPRO = {};

    (hist?.data?.trip_history_list || []).forEach(e=>{
      if (!MAP[e.task_no]) return;

      const m = MAP[e.task_no];
      if (!perPRO[m.PRO])
        perPRO[m.PRO] = { PRO:m.PRO, DO:m.DO, PU:m.PU, events:[] };

      perPRO[m.PRO].events.push({
        time: e.time,
        desc: e.event_description,
        user: e.user || ""
      });
    });

    /* 3) Shipment order history per DO ‚Üí append events */
    $("status").textContent = "Fetching Shipment History‚Ä¶";

    for (const pro of Object.keys(perPRO)) {
      const entry = perPRO[pro];

      // if no DO, behave like before (nothing extra)
      if (!entry.DO) {
        entry.events.push({
          time: "‚Äî",
          desc: "Shipment history unavailable (no DO)",
          user: ""
        });
        continue;
      }

      try {
        const ship = await api(SHIP_HISTORY_URL + entry.DO);
        // Your sample response is { data: [ {...}, ... ], ... }
        const list = Array.isArray(ship?.data) ? ship.data
                   : Array.isArray(ship?.data?.history) ? ship.data.history
                   : [];

        if (!list.length) {
          entry.events.push({
            time: "‚Äî",
            desc: "Shipment history unavailable",
            user: ""
          });
          continue;
        }

        list.forEach(s=>{
          entry.events.push({
            time: s.event_time || s.time || "",
            // show full event text so you can see status changes
            desc: `[Shipment] ${s.event || s.status_describe || s.status || ""}`,
            user: s.user_name || s.operator || ""
          });
        });

      } catch (err) {
        console.error("Shipment history error for", entry.DO, err);
        entry.events.push({
          time: "‚Äî",
          desc: "Shipment history unavailable",
          user: ""
        });
      }
    }

    /* 4) Render ‚Äî same format as your original output */
    $("status").textContent = "Rendering‚Ä¶";

    let out = "";

    for (const pro of Object.keys(perPRO).sort()) {

      const o = perPRO[pro];
      out += `PRO ${pro}\nDO  ${o.DO}\nPU  ${o.PU || "-"}\n`;

      o.events.sort((a,b)=> new Date(a.time) - new Date(b.time));

      o.events.forEach(e=>{
        const userPart = e.user ? ` (${e.user})` : "";
        out += `  ${e.time || "‚Äî"} | ${e.desc}${userPart}\n`;
      });

      out += "--------------------------------------------\n";
    }

    $("out").textContent = out || "No events found.";
    $("status").textContent = "‚úÖ Audit Complete";

  }catch(e){
    $("status").textContent = "‚ùå Error";
    $("out").textContent = e.message;
    console.error(e);
  }
}

$("run").addEventListener("click", audit);

})();
</script>
</body>
</html>
