<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 15px 0;
  font-size:26px;
}

.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
  width:190px;
}

button{
  cursor:pointer;
  border:none;
  border-radius:12px;
  padding:10px 18px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#05070b;
  font-weight:700;
  font-size:14px;
}

.status{
  color:var(--muted);
  margin:8px 0 6px;
}

.timer{
  color:#22d3ee;
  font-size:13px;
}

pre{
  background:#070b14;
  border-radius:12px;
  padding:16px;
  overflow:auto;
  max-height:70vh;
  font-size:13px;
  border:1px solid var(--border);
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
  <div class="row">
    <!-- Hardcoded credentials -->
    <input id="trip" placeholder="Trip #" style="width:160px">
    <button id="run">Run Audit</button>
  </div>

  <div class="status" id="status">Idle</div>
  <div class="timer" id="timer"></div>

  <pre id="out"></pre>
</div>
</div>

<script>
(()=>{

/* ===========================================================
   CONFIG
=========================================================== */

const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL   = `${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL   = `${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL = `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL    = `${BASE}/fms-platform-order/shipment-order-history/`;
const SEARCH_URL  = `${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

// HARD CODED LOGIN
const FMS_USER = "RaulEscobar";
const FMS_PASS = "FMSoffload1!";

const $ = id => document.getElementById(id);

let TOKEN=null;
let timerInt=null;

/* ===========================================================
   AUTH
=========================================================== */

async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({
      account: FMS_USER,
      password: FMS_PASS
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j=await r.json();
  TOKEN=j.token || j?.data?.token;

  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}

/* ===========================================================
   API
=========================================================== */

async function api(url){
  const t=await auth();

  const r=await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);

  return r.json();
}

/* ===========================================================
   UTILITIES
=========================================================== */

function normalizeDO(doVal){
  if(!doVal) return "";
  if(doVal.startsWith("DO")) return doVal;
  return "DO" + doVal.replace(/[^0-9]/g,"");
}

function looksUnDispatch(desc){
  desc=desc.toLowerCase();
  return (
    desc.includes("undispatch") ||
    desc.includes("un-dispatch") ||
    desc.includes("un dispatch") ||
    desc.includes("removed")
  );
}

/* ===========================================================
   SHIPMENT EVENT FILTERING
=========================================================== */

function extractShipmentEvent(e){
  const s = e?.event?.toLowerCase();
  if(!s) return null;

  if(
    s.includes("pickup") ||
    s.includes("delivery") ||
    s.includes("out for delivery") ||
    s.includes("changed order status") ||
    s.includes("deliver")
  ){
    return {
      time: e.event_time,
      text: e.event.split("].")[0] + "]"
    };
  }

  return null;
}

/* ===========================================================
   MAIN LOGIC
=========================================================== */

async function audit(){

  $("out").textContent="";
  $("status").textContent="Starting‚Ä¶";
  $("timer").textContent="";
  TOKEN=null;

  const tripNo = $("trip").value.trim();
  if(!tripNo) return alert("Trip # required");

  const start=Date.now();

  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);

  try{

    /* TASKS */
    $("status").textContent="Fetching tasks‚Ä¶";
    const tasks=await api(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};
    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no) return;

      MAP[t.task_no]={
        PRO: t.tracking_no || "",
        DO:  normalizeDO(t.shipment_order_no || t.order_no || ""),
        PU:  t.pu_no || "",
        TYPE: t.task_type_text?.toLowerCase() || ""
      };
    });

    /* trip history */
    $("status").textContent="Fetching trip history‚Ä¶";
    const hist=await api(`${HISTORY_URL}?tripNo=${tripNo}`);

    const perBucket={};

    (hist?.data?.trip_history_list||[]).forEach(ev=>{

      const raw  = ev.event_description || "";
      const desc = raw.toLowerCase();

      const isDispatch   = desc.includes("dispatched");
      const isUnDispatch = looksUnDispatch(desc);

      if(!isDispatch && !isUnDispatch) return;

      let PRO="", DO="", PU="", TYPE="";

      const map = ev.task_no ? MAP[ev.task_no] : null;
      if(map){
        PRO=map.PRO;
        DO =map.DO;
        PU =map.PU;
        TYPE=map.TYPE;
      }

      if(!PRO){
        const m=raw.match(/pro[#:\s]*([0-9]+)/i);
        if(m) PRO=m[1];
      }

      if(!DO){
        const m=raw.match(/do[#:\s]*([0-9]+)/i);
        if(m) DO=normalizeDO(m[1]);
      }

      const key = PRO || DO || "(none)";

      if(!perBucket[key]){
        perBucket[key]={
          PRO: PRO || "(none)",
          DO:  DO  || "-",
          PU:  PU  || "-",
          events:[]
        };
      }

      perBucket[key].events.push({
        type:"trip",
        time:ev.time,
        text:raw,
        user:ev.user||"",
        wantPickup: raw.toLowerCase().includes("pickup"),
        wantDelivery: raw.toLowerCase().includes("delivery")
      });

    });

    /* ===================================================
       SHIPMENT STITCHING WITH SEMANTIC MATCH
    =================================================== */

    $("status").textContent="Matching shipment events‚Ä¶";

    for(const bucket of Object.values(perBucket)){

      let DO=bucket.DO==="-"?"":bucket.DO;

      if(bucket.PRO && bucket.PRO!=="(none)"){
        try{
          const s=await api(SEARCH_URL + bucket.PRO);
          const found=s?.data?.orders?.[0]?.order_no;
          if(found){
            DO=normalizeDO(found);
            bucket.DO=DO;
          }
        }catch{}
      }

      let shipEvents=[];
      if(DO){
        try{
          const s=await api(SHIP_URL + DO);
          shipEvents=s?.data || [];
        }catch{}
      }

      const usedShip=new Set();
      const additions=[];

      bucket.events.forEach(te=>{

        let nearest=null;

        shipEvents.forEach((se,i)=>{

          if(usedShip.has(i)) return;

          const sx=extractShipmentEvent(se);
          if(!sx) return;

          const sxTxt=sx.text.toLowerCase();

          if(te.wantPickup && !sxTxt.includes("pickup")) return;
          if(te.wantDelivery && !(sxTxt.includes("delivery") || sxTxt.includes("out for delivery"))) return;

          const diff=Math.abs(new Date(te.time)-new Date(sx.time));

          if(!nearest || diff<nearest.diff){
            nearest={diff,sx,i};
          }
        });

        if(nearest){
          usedShip.add(nearest.i);
          additions.push({
            type:"ship",
            time:nearest.sx.time,
            text:nearest.sx.text,
            user:""
          });
        } else{
          additions.push({
            type:"ship",
            time:"",
            text:"‚Äî No shipment event ‚Äî",
            user:""
          });
        }

      });

      bucket.events=bucket.events.concat(additions);

      bucket.events.sort((a,b)=>{
        if(!a.time&&!b.time) return 0;
        if(!a.time) return 1;
        if(!b.time) return -1;

        const ta=new Date(a.time);
        const tb=new Date(b.time);

        if(ta.getTime()===tb.getTime()){
          return a.type==="trip"?-1:1;
        }

        return ta-tb;
      });

    }

    clearInterval(timerInt);
    $("status").textContent="‚úÖ Audit complete";

    let out="";

    Object.values(perBucket).forEach(r=>{

      out+=`PRO ${r.PRO}\n`;
      out+=`DO  ${r.DO}\n`;
      out+=`PU  ${r.PU}\n`;

      r.events.forEach(ev=>{
        const ts = ev.time || "                      ";
        out+=`  ${ts} | ${ev.text}${ev.user?` (${ev.user})`:""}\n`;
      });

      out+="--------------------------------------------\n";

    });

    $("out").textContent= out || "No events found.";

  }catch(e){

    clearInterval(timerInt);
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;

  }

}

$("run").addEventListener("click", audit);

})();

</script>
</body>
</html>
