<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FMS Trip Change Audit Bot</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --row:#141c2b;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --ok:#10b981;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1000px 600px at top,#121b2f,transparent 60%),var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;
}

.wrap{
  max-width:1200px;
  margin:28px auto;
  padding:18px;
}

h1{
  display:flex;
  align-items:center;
  gap:10px;
}

.controls{
  display:flex;
  gap:12px;
  margin:16px 0 24px;
}
input{
  background:#0b1220;
  border:1px solid #1f2933;
  border-radius:12px;
  color:#fff;
  padding:10px 14px;
  width:200px;
}
button{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none;
  border-radius:12px;
  padding:10px 18px;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.batch{
  background:linear-gradient(180deg,#121827,#0b1120);
  border-radius:18px;
  padding:18px;
  margin-bottom:26px;
  border:1px solid #1f2933;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

.batch-head{
  display:flex;
  gap:10px;
  margin-bottom:14px;
  flex-wrap:wrap;
}
.tag{
  background:#0b1220;
  border:1px solid #1f2933;
  padding:6px 12px;
  border-radius:999px;
  font-weight:600;
}

.trip-card{
  background:var(--row);
  border:1px solid #1f2933;
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}
.trip-line{
  color:var(--accent2);
  font-family:monospace;
  margin-bottom:6px;
}
.trip-desc{
  margin-bottom:6px;
}
.ship-box{
  background:#050912;
  border-left:4px solid var(--ok);
  padding:8px 12px;
  border-radius:10px;
  font-family:monospace;
}
.ship-missing{
  opacity:.5;
  font-style:italic;
}
</style>
</head>

<body>
<div class="wrap">

<h1>ðŸšš FMS Trip Change Audit Bot</h1>

<div class="controls">
  <input id="tripInput" value="B01MUK"/>
  <button onclick="runAudit()">Run Audit</button>
</div>

<div id="output"></div>

</div>

<script>
/***********************************************************
  MOCK SAMPLE DATA
  Replace fetch blocks later with real API payloads.
************************************************************/

// Trip History (driver / trip events)
const TRIP_EVENTS = [
  {
    pro:"367093", do:"DO251200003484", pu:"7709470",
    time:"2025-12-10T17:15:23",
    text:"Dispatched DO PRO# 367093 (Delivery Task task# 250000338325) by ManualDispatch"
  },
  {
    pro:"367093", do:"DO251200003484", pu:"7709470",
    time:"2025-12-10T17:15:23",
    text:"Dispatched DO PRO# 367093 (Pickup Task task# 250000338324) by ManualDispatch"
  }
];

// Shipment / order history
const SHIPMENT_EVENTS = [
  {
    time:"2025-12-10T17:15:00",
    text:"Delivery Task Dispatched to Trip B01MUK.Order was [Pickup Confirmed-PickupDispatched] .current trip [B01MUK]"
  },
  {
    time:"2025-12-10T17:15:00",
    text:"Pickup Task Dispatched to Trip B01MUK.Order was [New-New] .current trip []"
  }
];

/***********************************************************
  MATCHING ENGINE
************************************************************/

const TWO_MIN_MS = 2 * 60 * 1000;

function getAction(str){
  if(!str) return null;
  str = str.toLowerCase();
  if(str.includes("undispatch")) return "undispatch";
  if(str.includes("dispatched")) return "dispatch";
  return null;
}

function getTaskType(str){
  if(!str) return null;
  str=str.toLowerCase();
  if(str.includes("pickup")) return "pickup";
  if(str.includes("delivery")) return "delivery";
  return null;
}

// Extract shipment info with priority weighting
function extractShipment(row){
  const s=row.text.toLowerCase();
  const action=getAction(s);
  if(!action) return null;

  const type=getTaskType(s);

  let priority=3;
  if(
    s.includes("task dispatched to trip") ||
    s.includes("task undispatched from trip")
  ){
    priority=1; // true execution event
  }
  else if(
    s.includes("changed order status from") &&
    s.includes("to")
  ){
    priority=2; // status echo but real movement
  }

  return{
    time:new Date(row.time).getTime(),
    type,
    action,
    priority,
    text:row.text
  };
}

// Match shipments to a trip event
function matchShipment(trip){
  const tTime=new Date(trip.time).getTime();
  const tType=getTaskType(trip.text);
  const tAction=getAction(trip.text);

  let best=null;
  let bestDiff=999999999;

  for(const se of SHIPMENT_EVENTS){
    const ship=extractShipment(se);
    if(!ship) continue;

    const diff=Math.abs(ship.time - tTime);
    if(diff > TWO_MIN_MS) continue;

    // action must match
    if(ship.action !== tAction) continue;

    // prefer same task if known
    if(tType && ship.type && ship.type !== tType) continue;

    if(
      !best ||
      ship.priority < best.ship.priority ||
      (ship.priority === best.ship.priority && diff < bestDiff)
    ){
      bestDiff = diff;
      best = { ship };
    }
  }
  return best?.ship || null;
}


/***********************************************************
  UI RENDER
************************************************************/

function runAudit(){
  const output=document.getElementById("output");
  output.innerHTML="";

  const grouped={};

  for(const t of TRIP_EVENTS){
    const key=t.pro;
    if(!grouped[key]){
      grouped[key]={
        pro:t.pro,
        do:t.do,
        pu:t.pu,
        rows:[]
      };
    }
    grouped[key].rows.push(t);
  }

  for(const batch of Object.values(grouped)){
    const wrap=document.createElement("div");
    wrap.className="batch";

    const head=document.createElement("div");
    head.className="batch-head";
    head.innerHTML=`
      <div class="tag">PRO: ${batch.pro}</div>
      <div class="tag">DO: ${batch.do}</div>
      <div class="tag">PU: ${batch.pu}</div>
    `;
    wrap.appendChild(head);

    for(const row of batch.rows){
      const card=document.createElement("div");
      card.className="trip-card";

      const ship=matchShipment(row);

      card.innerHTML=`
        <div class="trip-line">${row.time}</div>
        <div class="trip-desc">${row.text}</div>
        <div class="ship-box ${!ship?'ship-missing':''}">
          ${ship ? ship.text : "â€” No shipment event â€”"}
        </div>
      `;

      wrap.appendChild(card);
    }

    output.appendChild(wrap);
  }
}

runAudit();
</script>

</body>
</html>
