<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Trip Change Audit Bot</title>

<style>
  :root{
    --bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;
    --accent:#7c3aed;--accent2:#22d3ee;--ok:#10b981;
    --bad:#ef4444;--border:#1f2a3a
  }
  *{box-sizing:border-box}
  body{
    background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    margin:0;padding:24px;
  }
  h1{margin-top:0}
  input,button{
    background:#0b0f19;
    border:1px solid var(--border);
    color:var(--text);
    border-radius:10px;
    padding:10px 12px;
  }
  button{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    border:none;
    font-weight:700;
    cursor:pointer;
  }
  pre{
    background:#0b0f19;
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    min-height:340px;
    max-height:500px;
    overflow:auto;
    white-space:pre-wrap;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
</style>
</head>

<body>

<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="row">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
</div>

<div class="row">
  <input id="trip" placeholder="Trip # (e.g. B01MKS)">
  <button onclick="run()">Run Audit</button>
</div>

<pre id="out">Idle‚Ä¶</pre>

<script>
(() => {

/* ================== CONFIG ================== */

const BASE     = "https://fms.item.com";
const COMPANY  = "SBFH";
const CLIENT   = "FMS_WEB";

const LOGIN_URL =
  `${BASE}/fms-platform-user/Auth/Login`;

const TRIP_HISTORY_URL =
  `${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;

const SHIPMENT_HISTORY_URL =
  `${BASE}/fms-platform-order/shipment-order-history`;

/* ================== HELPERS ================= */

const out = document.getElementById("out");
const log = t => out.textContent += t + "\n";
const ts  = t => new Date(t).getTime();

/* ================== AUTH ==================== */

async function auth(){

  log("üîê Logging in‚Ä¶");

  const res = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client": CLIENT,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      account: user.value,
      password: pass.value
    })
  });

  if(!res.ok)
    throw new Error(`Login failed HTTP ${res.status}`);

  const j = await res.json();

  const token = j?.token || j?.data?.token;

  if(!token)
    throw new Error("No token received");

  log("‚úÖ Authenticated\n");

  return token;
}

/* ================= FETCHERS ================= */

function buildHeaders(token){
  return {
    "accept":"application/json, text/plain, */*",
    "fms-client": CLIENT,
    "fms-token": token,
    "company-id": COMPANY
  };
}

async function fetchTrip(token,trip){

  log("üì• Loading trip history‚Ä¶");

  const r = await fetch(`${TRIP_HISTORY_URL}?tripNo=${trip}`,{
    headers: buildHeaders(token)
  });

  if(!r.ok)
    throw new Error(`Trip history HTTP ${r.status}`);

  const j = await r.json();

  return j?.data?.trip_history_list || [];
}

async function fetchShipmentHistory(token,DO){

  const r = await fetch(`${SHIPMENT_HISTORY_URL}/${DO}`,{
    headers: buildHeaders(token)
  });

  if(!r.ok)
    throw new Error(`Shipment history HTTP ${r.status}`);

  const j = await r.json();

  return j?.data || [];
}

/* ================= PARSERS =================== */

function extractPRO(e){
  if(e.tracking_no) return e.tracking_no;
  const m = e.event_description.match(/PRO#\s*(\d+)/i);
  return m ? m[1] : null;
}

function extractDO(text){
  const m = text.match(/DO(\d+)/i);
  return m ? "DO" + m[1] : null;
}

function classify(desc){
  if(/Dispatched/i.test(desc))
    return "Dispatch ‚Üí Added to Trip";
  if(/Removed|Undispatch/i.test(desc))
    return "Undispatch ‚Üí Removed from Trip";
  if(/Linehaul/i.test(desc))
    return "Linehaul Status Change";
  return null;
}

/* ================= CORRELATION =============== */

function correlate(ev,history){

  const t0 = ts(ev.time);

  let best = null;

  for(const h of history){
    const d = Math.abs(ts(h.event_time) - t0);
    if(d < 45000 && (!best || d < best.d)){
      best = {d,h};
    }
  }

  return best ? best.h.event : "No matching shipment history";
}

/* ================= RUN ======================= */

async function run(){

  out.textContent = "";

  try{

    const token = await auth();

    const tripNo = trip.value.trim();
    if(!tripNo) throw new Error("Trip is required");

    const tripEvents = await fetchTrip(token,tripNo);

    log(`üìÑ ${tripEvents.length} raw trip events\n`);

    const changes = [];

    tripEvents.forEach(e=>{
      const pro = extractPRO(e);
      const typ = classify(e.event_description);
      if(!pro || !typ) return;

      changes.push({
        pro,
        do   : extractDO(e.event_description),
        time : e.time,
        user : e.user || "",
        type : typ
      });
    });

    const pros=[...new Set(changes.map(x=>x.pro))];

    log(`üîç Found ${pros.length} impacted PRO(s)\n`);

    for(const pro of pros){

      log(`PRO ${pro}`);
      log("--------------------------------");

      const evs = changes.filter(x=>x.pro===pro);

      const DO  = evs[0].do;

      if(!DO){
        log("Unable to resolve DO\n");
        continue;
      }

      const shipmentHistory = await fetchShipmentHistory(token,DO);

      evs.forEach(ev=>{
        const status = correlate(ev, shipmentHistory);
        log(ev.time);
        log(`Action: ${ev.type}`);
        log(`User: ${ev.user}`);
        log(`Status Event: ${status}\n`);
      });

      log("\n");
    }

    log("‚úÖ AUDIT COMPLETE");

  }catch(err){

    log("\n‚ùå ERROR");
    log(err.message || err.toString());
  }
}

})();
</script>

</body>
</html>
