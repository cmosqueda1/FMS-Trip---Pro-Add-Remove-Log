<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>üöö FMS Trip Change Audit Bot</title>

<style>
body{background:#060b14;color:#e6edf6;font-family:system-ui;padding:24px}
h2{margin-bottom:10px}
input{
  padding:10px;
  background:#0f172a;
  border:1px solid #334155;
  color:#fff;
  border-radius:8px;
  margin-right:6px
}
button{
  padding:10px 18px;
  background:linear-gradient(135deg,#7c3aed,#22d3ee);
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer
}
#log{
  background:#020617;
  border:1px solid #1e293b;
  padding:14px;
  border-radius:12px;
  height:460px;
  overflow:auto;
  white-space:pre-wrap;
  font-family:Consolas,monospace
}
.success{color:#10b981}
.error{color:#ef4444}
</style>
</head>
<body>

<h2>üöö FMS Trip Change Audit Bot</h2>

<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<input id="trip" placeholder="Trip #">
<button onclick="runAudit()">Run Audit</button>

<pre id="log"></pre>

<script>
const FMS = "https://fms.item.com";

const LOGIN_URL = `${FMS}/fms-platform-user/Auth/Login`;
const TRIP_HISTORY = `${FMS}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const TASK_LIST = `${FMS}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const SHIPMENT_HISTORY = `${FMS}/fms-platform-order/shipment-orders/queryOrderLog`;

const logBox = document.getElementById("log");

function log(msg){
  logBox.textContent += msg + "\n";
}

async function runAudit(){

  logBox.textContent = "";

  const username = user.value.trim();
  const password = pass.value.trim();
  const tripNo = trip.value.trim().toUpperCase();

  try{

    // ===== LOGIN =====
    log("üîê Logging in...");

    const login = await fetch(LOGIN_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Accept":"application/json"
      },
      body: JSON.stringify({
        username,
        password
      }),
      credentials:"include"
    });

    if(!login.ok)
      throw new Error("Login failed");

    log("‚úÖ Authenticated\n");

    // ===== TRIP HISTORY =====
    log("üìñ Loading trip history...");
    const tripResp = await fetch(`${TRIP_HISTORY}?tripNo=${tripNo}`,{
      credentials:"include"
    });
    const tripData = await tripResp.json();

    const history = tripData?.data?.trip_history_list || [];
    log(`‚úÖ ${history.length} history records pulled`);

    const relevant = history.filter(x =>
      x.event_description?.includes("Dispatched") ||
      x.event_description?.includes("Undispatched")
    );

    log(`üîç ${relevant.length} dispatch change events detected\n`);

    // ===== TASK LIST =====
    log("üìã Loading trip tasks...");
    const taskResp = await fetch(`${TASK_LIST}?tripNo=${tripNo}`,{
      credentials:"include"
    });
    const taskData = await taskResp.json();

    const tasks = taskData?.data?.task_list || [];

    const taskMap = {};
    tasks.forEach(t=>{
      taskMap[t.task_no] = {
        do: t.shipment_order_no,
        pro: t.tracking_no
      };
    });

    // ===== AUDIT =====
    log("\n==============================");

    for(const ev of relevant){

      const tmap = taskMap[ev.task_no];
      if(!tmap) continue;

      const PRO = tmap.pro;
      const DO  = tmap.do;
      const ts  = ev.time.replace("T"," ");

      log(`\nPRO ${PRO} | ${DO}`);

      // ===== SHIPMENT HISTORY =====
      const shipResp = await fetch(
        `${SHIPMENT_HISTORY}?orderNo=${DO}`,
        { credentials:"include" }
      );

      const shipData = await shipResp.json();
      const logs = shipData?.data?.list || [];

      if(!logs.length){
        log("   ‚ö† No shipment status records");
        continue;
      }

      logs.sort((a,b)=>
        new Date(a.operate_time) - new Date(b.operate_time)
      );

      const evTime = new Date(ev.time);

      let before=null, after=null;

      for(let i=0;i<logs.length;i++){
        const t = new Date(logs[i].operate_time);
        if(t >= evTime){
          after = logs[i];
          before = logs[i-1];
          break;
        }
      }

      if(!before||!after){
        log("   ‚ö† Unable to correlate status");
        continue;
      }

      log(`   ${before.status_text} ‚Üí ${after.status_text} | ${ts}`);
    }

    log("\n‚úÖ AUDIT COMPLETE");

  }
  catch(err){
    log("‚ùå ERROR: "+err.message);
  }
}
</script>

</body>
</html>
