<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸšš FMS Trip Change Audit Bot</title>

<style>
  body {
    background:#060b14;
    color:#e6edf6;
    font-family:system-ui,Segoe UI,Roboto;
    padding:24px;
  }

  h1 {
    margin:0 0 18px 0;
  }

  input {
    padding:10px;
    background:#0f172a;
    border:1px solid #334155;
    color:#fff;
    border-radius:8px;
    margin-right:6px;
  }

  button {
    padding:10px 18px;
    background:linear-gradient(135deg,#7c3aed,#22d3ee);
    border:none;
    border-radius:10px;
    color:#000;
    font-weight:600;
    cursor:pointer;
  }

  #log {
    margin-top:20px;
    background:#020617;
    border:1px solid #1e293b;
    padding:14px;
    border-radius:12px;
    min-height:420px;
    white-space:pre-wrap;
    font-family:Consolas,monospace;
    overflow:auto;
  }

  .success{color:#10b981}
  .error{color:#ef4444}
  .title{color:#60a5fa}
</style>
</head>
<body>

<h1>ðŸšš FMS Trip Change Audit Bot</h1>

<input id="user" placeholder="Username">
<input id="pass" placeholder="Password" type="password">
<input id="trip" placeholder="Trip #">
<button onclick="runAudit()">Run Audit</button>

<div id="log"></div>

<script>
const FMS = "https://fms.item.com";

const LOGIN_URL =
   `${FMS}/fms-platform-user/Auth/Login`;

const TRIP_HISTORY =
   `${FMS}/fms-platform-dispatch-management/Trips/GetTripHistory`;

const TASK_LIST =
   `${FMS}/fms-platform-dispatch-management/TripDetail/GetTaskList`;

const SHIPMENT_HISTORY =
   `${FMS}/fms-platform-order/shipment-orders/queryOrderLog`;

const log = (...m)=> {
  document.getElementById("log").textContent += m.join(" ") + "\n";
};

async function runAudit(){

  document.getElementById("log").textContent = "";

  const username = user.value.trim();
  const password = pass.value.trim();
  const tripNo   = trip.value.trim().toUpperCase();

  if(!username||!password||!tripNo){
    log("âŒ Missing fields");
    return;
  }

  // ---------------- LOGIN ----------------
  try{
    log("ðŸ” Logging inâ€¦");

    const r = await fetch(LOGIN_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({username,password}),
      credentials:"include"
    });

    if(!r.ok) throw new Error("Login failed");

    log("âœ… Authenticated");
  }
  catch(e){
    log("âŒ LOGIN FAILED:", e.message);
    return;
  }

  // ----------- GET TRIP HISTORY -----------
  let historyData;
  try{
    log("ðŸ“– Fetching trip historyâ€¦");

    const r = await fetch(TRIP_HISTORY + `?tripNo=${tripNo}`,{
      credentials:"include"
    });

    historyData = await r.json();
  }
  catch(e){
    log("âŒ TRIP HISTORY FAILED:", e.message);
    return;
  }

  const events = historyData?.data?.trip_history_list || [];
  if(!events.length){
    log("No trip history found.");
    return;
  }

  log(`âœ… ${events.length} total events pulled`);

  // Filter only dispatch changes
  const dispatchEvents = events.filter(x =>
      x.event_description.includes("Dispatched") ||
      x.event_description.includes("Undispatched")
  );

  if(!dispatchEvents.length){
    log("ðŸš« No dispatched / undispatched events found.");
    return;
  }

  log(`ðŸ” ${dispatchEvents.length} dispatch change events detected\n`);

  // ---------- LOAD TASK LIST ----------
  let tasksData;
  try{
    log("ðŸ“‹ Loading task listâ€¦");

    const r = await fetch(TASK_LIST + `?tripNo=${tripNo}`,{
      credentials:"include"
    });

    tasksData = await r.json();
  }
  catch(e){
    log("âŒ TASK LIST FAILED:", e.message);
    return;
  }

  const taskList = tasksData?.data?.task_list || [];

  // task_no => DO mapping
  const taskMap = {};
  taskList.forEach(t=>{
      taskMap[t.task_no] = {
         do : t.shipment_order_no,
         pro: t.tracking_no
      };
  });

  // ---------- AUDIT EACH EVENT ----------
  log("\n==============================");

  for(const ev of dispatchEvents){

     const task = taskMap[ev.task_no];
     if(!task) continue;

     const PRO = task.pro;
     const DO  = task.do;
     const ts  = ev.time.replace("T"," ");

     log(`\n${PRO} | ${DO}`);

     // ------ SHIPMENT HISTORY LOOKUP ------
     let shipLog;

     try{
       const r = await fetch(SHIPMENT_HISTORY + `?orderNo=${DO}`,{
         credentials:"include"
       });
       shipLog = await r.json();
     }
     catch(e){
       log("   âš  Failed shipment history lookup");
       continue;
     }

     const hist = shipLog?.data?.list || [];
     hist.sort((a,b)=> new Date(a.operate_time)-new Date(b.operate_time));

     const evTime = new Date(ev.time);

     let prev = null, curr = null;

     for(let i=0;i<hist.length;i++){
        const t = new Date(hist[i].operate_time);
        if(t >= evTime){
          curr = hist[i];
          prev = hist[i-1];
          break;
        }
     }

     if(!prev || !curr){
        log("   âš  Unable to correlate status");
        continue;
     }

     log(`   ${prev.status_text} â†’ ${curr.status_text} | ${ts}`);
  }

  log("\nâœ… AUDIT COMPLETE");
}
</script>

</body>
</html>
