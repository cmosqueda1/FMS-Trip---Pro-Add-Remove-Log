<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FMS Trip Change Audit Bot</title>

<style>
/* =====================
   THEME
===================== */
:root{
  --bg:#05070b;
  --vignette1:#0b0f1a;
  --vignette2:#020408;
  --card:#0f1420;
  --pair:#0b0f1c;
  --border:#1f2933;

  --text:#e6edf6;
  --muted:#93a4b7;

  --trip:#22d3ee;   /* cyan */
  --ship:#a78bfa;   /* violet */

  --accent:#7c3aed;
  --accent2:#22d3ee;
}

/* =====================
   BASE
===================== */

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(1200px 700px at 15% -10%, #121a2b 0%, transparent 55%),
    radial-gradient(900px 600px at 100% 10%, #0e1424 0%, transparent 50%),
    linear-gradient(180deg,var(--vignette1),var(--vignette2));
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
}

.wrap{
  max-width:1200px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 16px 0;
  font-size:26px;
}

.toolbar{
  display:flex;
  gap:12px;
}

input{
  background:#0b0f19;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
  font-size:14px;
  width:160px;
}

button{
  cursor:pointer;
  border:none;
  border-radius:12px;
  padding:10px 20px;
  font-weight:700;
  font-size:14px;
  color:#05070b;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
}

.status{
  margin-top:8px;
  color:var(--muted);
}

.timer{
  color:var(--trip);
  font-size:13px;
  margin-bottom:18px;
}

/* =====================
   ORDER CARDS
===================== */

.orders{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.order-card{
  background:
    linear-gradient(180deg,#111827,#0b1220);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  box-shadow:0 18px 40px rgba(0,0,0,.5);
  backdrop-filter: blur(8px);
}

.order-header{
  border-bottom:1px solid var(--border);
  margin-bottom:12px;
  padding-bottom:8px;
}

.order-title{
  font-size:17px;
  font-weight:700;
}

.order-meta{
  margin-top:2px;
  font-size:13px;
  color:var(--muted);
}

/* =====================
 EVENT PAIRS
===================== */

.pair{
  background:var(--pair);
  border:1px solid #192034;
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
}

/* shared event row */
.event{
  display:grid;
  grid-template-columns:160px 1fr;
  gap:10px;
  font-size:13px;
  line-height:1.35;
}

.time{
  font-family:monospace;
}

/* TRIP = CYAN GLOW */
.trip{
  color:var(--trip);
  border-left:3px solid var(--trip);
  padding-left:10px;
  margin-bottom:6px;
  text-shadow:0 0 6px rgba(34,211,238,.4);
}

/* SHIPMENT = PURPLE GLOW */
.ship{
  color:var(--ship);
  border-left:3px solid var(--ship);
  padding-left:10px;
  text-shadow:0 0 6px rgba(167,139,250,.4);
}

/* NO SHIP MATCH */
.ship.empty{
  color:#64748b;
  border-left-color:#475569;
  text-shadow:none;
}

.empty{
  margin-top:30px;
  color:var(--muted);
  text-align:center;
}
</style>
</head>

<body>

<div class="wrap">

<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="toolbar">
  <input id="trip" placeholder="Trip #">
  <button id="run">Run Audit</button>
</div>

<div class="status" id="status">Idle</div>
<div class="timer" id="timer"></div>

<div class="orders" id="out"></div>

</div>

<script>
(()=>{

const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL=`${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL=`${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL=`${BASE}/fms-platform-order/shipment-order-history/`;
const SEARCH_URL=`${BASE}/fms-platform-dispatch-management/search-all?Keyword=`;

const $=id=>document.getElementById(id);

let TOKEN=null;
let timerInt=null;

async function auth(){
  if(TOKEN) return TOKEN;

  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({
      account:"RaulEscobar",
      password:"FMSoffload1!"
    })
  });

  const j=await r.json();
  TOKEN=j.token||j?.data?.token;
  if(!TOKEN) throw new Error("Login failed");
  return TOKEN;
}

async function api(url){
  const t=await auth();
  const r=await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

function extractShipmentEvent(e){
  const s=e?.event?.toLowerCase();
  if(!s) return null;
  if(
    s.includes("changed order status") ||
    s.includes("delivered") ||
    s.includes("pickup") ||
    s.includes("out for delivery")
  ){
    return{
      time:e.event_time,
      text:e.event.split("].")[0]+"]"
    };
  }
  return null;
}

function looksUnDispatch(desc){
  desc=desc.toLowerCase();
  return desc.includes("undispatch")||desc.includes("un dispatch")||desc.includes("removed");
}

function normalizeDO(v){
  if(!v)return"";
  if(v.startsWith("DO"))return v;
  return "DO"+v.replace(/[^0-9]/g,"");
}

/* =====================
 MAIN
===================== */

async function audit(){

  $("out").innerHTML="";
  $("status").textContent="Starting‚Ä¶";
  $("timer").textContent="";
  TOKEN=null;

  const trip=$("trip").value.trim();
  if(!trip) return alert("Trip # required");

  const start=Date.now();
  timerInt=setInterval(()=>{
    $("timer").textContent=`Elapsed: ${((Date.now()-start)/1000).toFixed(2)}s`;
  },100);

  try{

    const tasks=await api(`${TASKS_URL}?tripNo=${trip}`);

    const MAP={};
    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no)return;
      MAP[t.task_no]={
        PRO:t.tracking_no||"",
        DO:normalizeDO(t.shipment_order_no||t.order_no||""),
        PU:t.pu_no||""
      };
    });

    const hist=await api(`${HISTORY_URL}?tripNo=${trip}`);

    const buckets={};

    (hist?.data?.trip_history_list||[]).forEach(ev=>{
      const raw=ev.event_description||"";
      const desc=raw.toLowerCase();

      if(!desc.includes("dispatched")&&!looksUnDispatch(desc))return;

      let PRO="",DO="",PU="";
      const m=ev.task_no?MAP[ev.task_no]:null;
      if(m){PRO=m.PRO;DO=m.DO;PU=m.PU;}

      if(!PRO){
        const pm=raw.match(/pro[#:\s]*([0-9]+)/i);
        if(pm)PRO=pm[1];
      }

      if(!DO){
        const dm=raw.match(/do[#:\s]*([0-9]+)/i);
        if(dm)DO=normalizeDO(dm[1]);
      }

      if(!DO&&ev.order_no)DO=normalizeDO(ev.order_no);

      const key=PRO||DO||"(none)";

      if(!buckets[key]){
        buckets[key]={PRO:PRO||"(none)",DO:DO||"-",PU:PU||"-",tripEvents:[]};
      }

      buckets[key].tripEvents.push({
        time:ev.time,
        text:raw
      });
    });

    for(const k in buckets){
      const r=buckets[k];

      let DO=r.DO==="-"?"":r.DO;

      if(r.PRO && r.PRO!=="(none)"){
        try{
          const s=await api(SEARCH_URL+r.PRO);
          const found=s?.data?.orders?.[0]?.order_no;
          if(found){
            DO=normalizeDO(found);
            r.DO=DO;
          }
        }catch{}
      }

      let ships=[];
      if(DO){
        try{
          ships=(await api(SHIP_URL+DO))?.data||[];
        }catch{}
      }

      r.pairs=[];

      r.tripEvents.forEach(t=>{
        let best=null;
        ships.forEach(s=>{
          const sx=extractShipmentEvent(s);
          if(!sx) return;

          const diff=Math.abs(new Date(t.time)-new Date(sx.time));
          if(!best||diff<best.diff){
            best={diff,sx};
          }
        });

        r.pairs.push({
          trip:t,
          ship:best?best.sx:{time:"",text:"‚Äî No shipment event ‚Äî"}
        });
      });
    }

    clearInterval(timerInt);
    $("status").textContent="‚úÖ Audit complete";

    for(const k in buckets){
      const r=buckets[k];

      const card=document.createElement("div");
      card.className="order-card";

      card.innerHTML=`
        <div class="order-header">
          <div class="order-title">PRO ${r.PRO}</div>
          <div class="order-meta">DO ${r.DO} &nbsp;&nbsp;|&nbsp;&nbsp; PU ${r.PU}</div>
        </div>
      `;

      r.pairs.forEach(p=>{
        const pair=document.createElement("div");
        pair.className="pair";

        pair.innerHTML=`
          <div class="event trip">
            <div class="time">${p.trip.time}</div>
            <div>${p.trip.text}</div>
          </div>

          <div class="event ship ${p.ship.time?``:`empty`}">
            <div class="time">${p.ship.time||" "}</div>
            <div>${p.ship.text}</div>
          </div>
        `;

        card.appendChild(pair);
      });

      $("out").appendChild(card);
    }

    if(!$("out").children.length){
      $("out").innerHTML=`<div class="empty">No events found.</div>`;
    }

  }catch(e){
    clearInterval(timerInt);
    $("status").textContent="‚ùå Error";
    $("out").innerHTML=`<div class="empty">${e.message}</div>`;
  }
}

$("run").addEventListener("click",audit);

})();
</script>

</body>
</html>
