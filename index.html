<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
  body{
    margin:0;
    background:#05070b;
    color:#e6edf6;
    font-family:Inter,system-ui,Arial;
  }
  .wrap{max-width:1100px;margin:40px auto;padding:20px;}
  h1{margin-top:0}
  input,button{
    background:#0b0f19;
    color:#e6edf6;
    border:1px solid #1f2933;
    border-radius:10px;
    padding:10px 14px;
    font-size:14px;
  }
  button{
    cursor:pointer;
    background:linear-gradient(90deg,#7c3aed,#22d3ee);
    border:none;
    color:#05070b;
    font-weight:700;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;}
  .card{
    background:#0f1420;
    border:1px solid #1f2933;
    border-radius:16px;
    padding:16px;
  }
  pre{
    background:#0b0f19;
    border-radius:12px;
    padding:16px;
    overflow:auto;
    max-height:70vh;
    font-size:13px;
  }
  .status{margin:10px 0;color:#93a4b7;}
</style>
</head>

<body>
<div class="wrap">
<h1>üöö FMS Trip Change Audit Bot</h1>

<div class="card">
<div class="row">
<input id="user" placeholder="Username">
<input id="pass" placeholder="Password" type="password">
<input id="trip" placeholder="Trip #" style="width:160px">
<button id="run">Run Audit</button>
</div>
<div class="status" id="status">Idle</div>
<pre id="out"></pre>
</div>
</div>

<script>
(()=>{

/* =========================================
   CONFIG
========================================= */

const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL=`${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL=`${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_HISTORY=`${BASE}/fms-platform-order/shipment-orders/queryOrderLog`;

const $=id=>document.getElementById(id);
let TOKEN=null;

/* =========================================
   AUTH ‚Äì UNCHANGED
========================================= */
async function auth(){
  if(TOKEN) return TOKEN;

  $("status").textContent="Logging in‚Ä¶";

  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "fms-client":CLIENT,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  if(!r.ok) throw new Error("Login failed");

  const j = await r.json();
  TOKEN = j.token || j?.data?.token;

  if(!TOKEN) throw new Error("Token missing");

  return TOKEN;
}


/* =========================================
   API HELPERS
========================================= */

async function apiGET(url){
  const t = await auth();

  const r = await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

async function apiPUT(url){
  const t = await auth();

  const r = await fetch(url,{
    method:"PUT",
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}


/* =========================================
   AI MATCHER ‚Äì PICKS SINGLE BEST EVENT
========================================= */
function pickBestShipmentEvent(logs, tripTime, pro, tripNo){

  let best=null;
  let bestScore=-1;

  const tTs = new Date(tripTime).getTime();

  logs.forEach(l=>{

    const txt = (l.event || "").toLowerCase();
    let score=0;

    if(txt.includes("changed order status")) score+=10;
    if(txt.includes("taskdispatched") || txt.includes("taskundispatched")) score+=9;
    if(txt.includes("dispatched")) score+=7;
    if(txt.includes("undispatched")) score+=7;
    if(txt.includes("from [") && txt.includes("] to [")) score+=6;

    // Timestamp proximity
    try{
      const evTs=new Date(l.event_time).getTime();
      const delta=Math.abs(evTs - tTs);

      if(delta<=2000) score+=5;
      else if(delta<=5000) score+=2;
    }catch{}

    if(txt.includes(pro)) score+=4;
    if((l.trip_no_or_linehaul||"") === tripNo) score+=3;

    if(score>bestScore){
      bestScore=score;
      best=l;
    }

  });

  return best;
}


/* =========================================
   MAIN AUDIT LOGIC
========================================= */
async function audit(){

  $("out").textContent="";
  TOKEN=null;

  try{

    const tripNo = $("trip").value.trim();
    if(!tripNo) throw new Error("Trip # required");

    $("status").textContent="Fetching Task List‚Ä¶";
    const tasks = await apiGET(`${TASKS_URL}?tripNo=${tripNo}`);

    const MAP={};

    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no||!t.tracking_no) return;

      MAP[t.task_no]={
        PRO:t.tracking_no,
        DO:t.shipment_order_no||t.order_no||"",
        PU:t.pu_no||""
      };
    });

    $("status").textContent="Fetching Trip History‚Ä¶";
    const history = await apiGET(`${HISTORY_URL}?tripNo=${tripNo}`);

    let perPRO={};

    (history?.data?.trip_history_list||[]).forEach(e=>{
      if(!MAP[e.task_no]) return;

      const m=MAP[e.task_no];
      if(!perPRO[m.PRO]){
        perPRO[m.PRO]={PRO:m.PRO,DO:m.DO,PU:m.PU,events:[]};
      }

      perPRO[m.PRO].events.push({
        time:e.time,
        desc:e.event_description,
        user:e.user
      });
    });


    $("status").textContent="Fetching Shipment Histories (AI match)‚Ä¶";

    for(const pro of Object.keys(perPRO)){

      const o = perPRO[pro];
      if(!o.DO || o.events.length===0) continue;

      try{

        // Shipment history MUST be PUT
        const ship = await apiPUT(
          `${SHIP_HISTORY}?orderNo=${o.DO}`
        );

        const logs = ship?.data || [];
        const best = pickBestShipmentEvent(logs,o.events[0].time,o.PRO,tripNo);

        if(best){
          o.events.push({
            time: best.event_time,
            desc: `Shipment ‚Üí ${best.event}`,
            user: best.user_name || ""
          });
        }

      }catch{
        // silent fail ‚Äî shipment history not fatal
      }
    }


    $("status").textContent="Rendering output‚Ä¶";

    let out="";

    for(const pro of Object.keys(perPRO).sort()){

      const o=perPRO[pro];

      out+=`PRO ${pro}\n`;
      out+=`DO  ${o.DO||"-"}\n`;
      out+=`PU  ${o.PU||"-"}\n`;

      o.events.sort((a,b)=> new Date(a.time)-new Date(b.time));

      o.events.forEach(e=>{
        out+=`  ${e.time} | ${e.desc}${e.user?` (${e.user})`:""}\n`;
      });

      out+="--------------------------------------------\n";
    }

    $("out").textContent=out || "No events found.";
    $("status").textContent="‚úÖ Audit Complete";

  }catch(err){

    $("status").textContent="‚ùå ERROR";
    $("out").textContent=err.message;
    console.error(err);

  }

}


/* =========================================
   UI
========================================= */

$("run").addEventListener("click",audit);

})();
</script>
</body>
</html>
