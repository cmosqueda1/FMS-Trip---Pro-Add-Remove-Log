<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FMS Trip Change Audit Bot</title>

<style>
:root{
  --bg:#05070b;
  --panel:#0f1420;
  --panel-soft:#0b0f19;
  --border:#1f2933;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent1:#7c3aed;
  --accent2:#22d3ee;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  background:
    radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Arial;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{
  margin:0 0 12px 0;
  font-size:24px;
}

.subtitle{
  color:var(--muted);
  margin-bottom:18px;
}

.card{
  background:linear-gradient(180deg,#101828,#0b0f19);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.55);
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

input{
  background:var(--panel-soft);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 14px;
  color:var(--text);
  font-size:14px;
  flex:1;
  min-width:180px;
}

button{
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color:#05070b;
  border:none;
  border-radius:10px;
  padding:10px 18px;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
}

.statusbar{
  margin-top:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  color:var(--muted);
  font-size:13px;
}

meter{
  width:100%;
  height:8px;
}

pre{
  background:var(--panel-soft);
  border-radius:14px;
  padding:16px;
  margin-top:14px;
  overflow:auto;
  max-height:70vh;
  border:1px solid var(--border);
  font-size:13px;
  line-height:1.55em;
}
</style>
</head>

<body>
<div class="wrap">

<h1>üöö FMS Trip Change Audit Bot</h1>
<div class="subtitle">
Run a trip audit and match shipment status change events.
</div>

<div class="card">

<div class="row">
  <input id="user" placeholder="Username">
  <input id="pass" placeholder="Password" type="password">
  <input id="trip"  placeholder="Trip #" style="max-width:140px">
  <button id="run">Run Audit</button>
</div>

<div class="statusbar">
  <span id="status">Idle</span>
  <span id="timer">Elapsed: 00:00.0</span>
</div>

<meter id="prog" min="0" max="100" value="0"></meter>

<pre id="out"></pre>

</div>

</div>

<script>
(()=>{

/* ---------------- CONFIG ---------------- */
const BASE="https://fms.item.com";
const CLIENT="FMS_WEB";

const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const TASKS_URL=`${BASE}/fms-platform-dispatch-management/TripDetail/GetTaskList`;
const HISTORY_URL=`${BASE}/fms-platform-dispatch-management/Trips/GetTripHistory`;
const SHIP_URL=`${BASE}/fms-platform-order/shipment-order-history/`;

/* ---------------- STATE ---------------- */
const $=id=>document.getElementById(id);
let TOKEN=null;

let START_TIME=null;
let TIMER_ID=null;

/* ---------------- TIMER ---------------- */
function startTimer(){
  START_TIME=Date.now();
  clearInterval(TIMER_ID);

  TIMER_ID=setInterval(()=>{
    const diff=Date.now()-START_TIME;
    const sec=(diff/1000).toFixed(1);
    const m=Math.floor(sec/60).toString().padStart(2,"0");
    const s=(sec%60).toFixed(1).padStart(4,"0");
    $("timer").textContent=`Elapsed: ${m}:${s}`;
  },100);
}

function stopTimer(){
  clearInterval(TIMER_ID);
}

/* ---------------- AUTH ---------------- */
async function auth(){
  if(TOKEN) return TOKEN;

  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":CLIENT
    },
    body:JSON.stringify({
      account:$("user").value.trim(),
      password:$("pass").value.trim()
    })
  });

  const j=await r.json();
  TOKEN=j.token||j?.data?.token;

  if(!TOKEN) throw new Error("Login failed");
  return TOKEN;
}

/* ---------------- API ---------------- */
async function api(url){
  const t=await auth();

  const r=await fetch(url,{
    headers:{
      "accept":"application/json",
      "Content-Type":"application/json",
      "fms-client":CLIENT,
      "fms-token":t
    }
  });

  if(!r.ok) throw new Error(`HTTP ${r.status}`);

  return r.json();
}

/* ---------------- HELPERS ---------------- */
function shortenShipmentEvent(txt){
  const m=txt.match(/Event\s\[.*?\]\sChanged Order Status From\s\[[^\]]+\]\s+to\s+\[[^\]]+\]/);
  return m?m[0]:"";
}

function matchShipment(ts, list){

  const t0=new Date(ts).getTime();
  let best=null;
  let d0=9e12;

  for(const e of list){
    if(!/Changed Order Status/i.test(e.event)) continue;

    const t=new Date(e.event_time).getTime();
    const d=Math.abs(t-t0);

    if(d<d0){
      d0=d;
      best=e;
    }
  }

  return best;
}

/* ---------------- MAIN ---------------- */
async function runAudit(){

  $("out").textContent="";
  $("prog").value=0;
  $("status").textContent="Running‚Ä¶";

  TOKEN=null;

  startTimer();

  try{

    const trip=$("trip").value.trim();
    if(!trip) throw new Error("Trip # required");

    $("prog").value=20;

    const tasks=await api(`${TASKS_URL}?tripNo=${trip}`);

    const MAP={};

    (tasks?.data||[]).forEach(t=>{
      if(!t.task_no||!t.tracking_no) return;
      MAP[t.task_no]={
        PRO:t.tracking_no,
        DO:t.shipment_order_no||t.order_no||"",
        PU:t.pu_no||""
      };
    });

    $("prog").value=45;

    const hist=await api(`${HISTORY_URL}?tripNo=${trip}`);

    let perPRO={};

    (hist?.data?.trip_history_list||[]).forEach(e=>{
      if(!MAP[e.task_no]) return;
      if(!/Dispatched/i.test(e.event_description)) return;

      const m=MAP[e.task_no];

      if(!perPRO[m.PRO]){
        perPRO[m.PRO]={
          PRO:m.PRO,
          DO:m.DO,
          PU:m.PU,
          dispatch:[]
        };
      }

      perPRO[m.PRO].dispatch.push({
        time:e.time,
        desc:e.event_description,
        user:e.user
      });
    });

    $("prog").value=70;

    for(const p of Object.values(perPRO)){

      if(!p.DO) continue;

      const sh=await api(SHIP_URL+p.DO);
      const lst=sh?.data||[];

      p.dispatch.forEach(d=>{
        const best=matchShipment(d.time,lst);

        if(best){
          d.ship={
            time:best.event_time,
            desc:shortenShipmentEvent(best.event)
          };
        }
      });
    }

    $("prog").value=90;

    let out="";

    Object.values(perPRO).sort((a,b)=>a.PRO.localeCompare(b.PRO))
    .forEach(p=>{
      out+=`PRO ${p.PRO}\n`;
      out+=`DO  ${p.DO}\n`;
      out+=`PU  ${p.PU||"-"}\n`;

      for(const d of p.dispatch){
        out+=`  ${d.time} | ${d.desc} (${d.user})\n`;
        if(d.ship?.desc){
          out+=`  ${d.ship.time} | ${d.ship.desc}\n`;
        }
      }

      out+="--------------------------------------------\n";
    });

    $("out").textContent=out||"No dispatch activity found.";

    $("prog").value=100;
    $("status").textContent="‚úÖ Audit Complete";

  }catch(e){
    $("status").textContent="‚ùå Error";
    $("out").textContent=e.message;
    console.error(e);
  }

  stopTimer();
}

/* ---------------- EVENTS ---------------- */
$("run").addEventListener("click",runAudit);

})();
</script>
</body>
</html>
